<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Peta Infrastruktur - MalukuInfraZone</title>
  <link rel="icon" type="image/png" href="images/favicon.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@300;400;600;700;800&family=Poppins:wght@300;400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{--bg:#071024;--muted:#a7b6c8;--accent:#3b82f6}
    html,body{height:100%;margin:0;font-family:"Poppins",system-ui,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,var(--bg),#05060a);color:#fff}
    .wrap{max-width:1400px;margin:20px auto;padding:20px;text-align:center}
    header{display:flex;justify-content:space-between;align-items:center;gap:12px;text-align:left}
    .title{font-weight:700;font-family:"Raleway",Poppins,system-ui,Segoe UI,Roboto,Arial}
    .btn{display:inline-block;padding:8px 14px;border-radius:8px;text-decoration:none;font-weight:700;cursor:pointer}
    .btn-back{background:rgba(255,255,255,0.04);color:#e6eef7;border:1px solid rgba(255,255,255,0.08)}
    .controls{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .select-wrap{position:relative;display:inline-block}
    .select{background:#ffffff;color:#021129;padding:8px 12px;border-radius:8px;border:1px solid var(--accent);min-width:160px;font-weight:600;appearance:none}
    .select-wrap::after{content:"";position:absolute;right:10px;top:50%;transform:translateY(-50%);width:0;height:0;border-left:6px solid transparent;border-right:6px solid transparent;border-top:8px solid #021129;pointer-events:none}
    select::-ms-expand{display:none}
    #map{width:100%;height:85vh;border-radius:12px;background:#0b1220;box-shadow:0 10px 30px rgba(0,0,0,0.6);margin-top:14px;display:block}
    .status{margin-top:8px;color:var(--muted);font-size:13px}

    /* Legend grid and items */
    .legend{
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap:12px;
      margin-top:12px;
      padding:12px;
      background:rgba(0,0,0,0.45);
      border-radius:10px;
      box-shadow:0 6px 18px rgba(0,0,0,0.45);
      z-index:9999;
      max-width:1200px;
      margin-left:auto;
      margin-right:auto;
      grid-auto-rows: 64px;
      align-items:center;
    }
    .legend-item{
      display:flex;
      align-items:center;
      gap:12px;
      padding:10px 14px;
      background:rgba(255,255,255,0.03);
      border-radius:10px;
      font-size:14px;
      color:#e6eef7;
      min-width:220px;
      min-height:56px;
      box-sizing:border-box;
    }
    .legend-item img{width:28px;height:28px;object-fit:contain;filter:drop-shadow(0 3px 6px rgba(0,0,0,0.4))}
    .legend-item span{display:block;text-align:left;line-height:1.2;white-space:normal;word-break:break-word}

    @media(max-width:900px){
      .legend{grid-template-columns: repeat(2, minmax(0,1fr)); grid-auto-rows:auto}
      #map{height:65vh}
      .controls{flex-direction:column;align-items:flex-start}
      .footer-inner{gap:20px;justify-content:center}
    }

.gm-style .gm-style-iw,
.gm-style .gm-style-iw > div,
.gm-style .gm-style-iw-d,
.gm-style .gm-style-iw-c,
.gm-style .gm-style-iw-t {
  background: transparent !important;
  box-shadow: none !important;
  padding: 0 !important;
  margin: 0 !important;
  overflow: visible !important;
  width: auto !important;
  max-width: none !important;
  display: inline-block !important;
}

/* pastikan container google tidak menambah latar putih atau lebar */
.gm-style .gm-style-iw::after,
.gm-style .gm-style-iw > div::after,
.gm-style .gm-style-iw-d::after,
.gm-style .gm-style-iw-c::after,
.gm-style .gm-style-iw-t::after { display: none !important; }

/* kecilkan & posisikan kontrol close default */
.gm-ui-hover-effect{
  display:flex !important;
  width:26px !important;
  height:26px !important;
  top:8px !important;
  right:8px !important;
  border-radius:6px !important;
  background:#fff !important;
  border:1px solid rgba(0,0,0,0.08) !important;
  box-shadow:0 4px 10px rgba(2,6,23,0.08) !important;
  align-items:center !important;
  justify-content:center !important;
  z-index:9999 !important;
}

/* ikon tombol close kecil */
.gm-ui-hover-effect img, .gm-ui-hover-effect svg, .gm-ui-hover-effect span {
  width:12px !important;
  height:12px !important;
  display:block !important;
  margin:0 !important;
  transform:none !important;
}

/* konten actual: satu kotak bersih */
.custom-iw{
  font-size:13px;
  color:#021129;
  background:#fff;
  padding:12px 14px;
  border-radius:8px;
  max-width:320px;
  text-align:left;
  line-height:1.4;
  box-shadow:0 8px 20px rgba(2,6,23,0.08);
  border:1px solid rgba(0,0,0,0.06);
  position:relative;
  overflow:visible;
  word-break:break-word;
}
    .custom-iw>div{margin:0;padding:0}

    /* ensure Google wrapper doesn't force scroll */
    .gm-style-iw-d, .gm-style-iw-c, .gm-style-iw-t { max-height:none !important; overflow:visible !important; }

    /* Footer */
    .site-footer{background:#050505;color:#d1d5db;padding:24px 20px;margin-top:20px;border-radius:8px;text-align:left}
    .footer-inner{max-width:1200px;margin:0 auto;display:flex;gap:40px;justify-content:space-between;align-items:flex-start;flex-wrap:wrap}
    .footer-brand .logo{font-weight:700}
    .footer-col h4{margin:0 0 8px 0;color:#fff}
    .footer-note{margin-top:8px;color:#9ca3af;font-size:13px}
    .footer-links{list-style:none;padding:0;margin:0}
    .footer-links li{margin:6px 0}
    .footer-bottom{margin-top:16px;border-top:1px solid rgba(255,255,255,0.03);padding-top:12px;text-align:center;color:#9ca3af;font-size:13px}

    .goto-top{position:fixed;right:20px;bottom:28px;width:44px;height:44px;border-radius:22px;background:#111;color:#fff;display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 6px 18px rgba(0,0,0,0.4)}
    .goto-top span{font-size:18px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <div class="title">Peta Infrastruktur — MalukuInfraZone</div>
        <div style="font-size:13px;color:var(--muted)">BPBPK Maluku</div>
      </div>
      <div class="controls" aria-hidden="false">
        <a href="index.html" class="btn btn-back">Kembali</a>
      </div>
    </header>

    <div style="margin-top:12px;display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:center">
      <label style="font-size:13px;color:var(--muted)">Sektor</label>
      <div class="select-wrap"><select id="sectorFilter" class="select"></select></div>
      <label style="font-size:13px;color:var(--muted)">Wilayah</label>
      <div class="select-wrap"><select id="regionFilter" class="select"></select></div>
      <label style="font-size:13px;color:var(--muted)">Tahun</label>
      <div class="select-wrap"><select id="yearFilter" class="select"></select></div>
      <label style="font-size:13px;color:var(--muted)">Jenis Kegiatan</label>
      <div class="select-wrap"><select id="jenisFilter" class="select"></select></div>
      <label style="font-size:13px;color:var(--muted)">Status Keberfungsian</label>
      <div class="select-wrap"><select id="statusFilter" class="select"></select></div>
      <button id="applyBtn" class="btn" style="background:var(--accent);color:#021129">Terapkan</button>
      <button id="resetBtn" class="btn btn-back">Reset</button>
    </div>

    <div id="map" role="application" aria-label="Peta Infrastruktur"></div>
    <div id="status" class="status">Menunggu pemuatan peta...</div>

    <div class="legend" role="region" aria-label="Legend Sektor" id="legendContainer">
      <div class="legend-item"><img src="images/icon-air-reguler.png" alt=""><span>Air Minum - Reguler</span></div>
      <div class="legend-item"><img src="images/icon-air-masyarakat.png" alt=""><span>Air Minum - Berbasis Masyarakat</span></div>
      <div class="legend-item"><img src="images/icon-sanitasi-reguler.png" alt=""><span>Sanitasi - Reguler</span></div>
      <div class="legend-item"><img src="images/icon-sanitasi-masyarakat.png" alt=""><span>Sanitasi - Berbasis Masyarakat</span></div>
      <div class="legend-item"><img src="images/icon-bina.png" alt=""><span>Bina Penataan Bangunan</span></div>
      <div class="legend-item"><img src="images/icon-kawasan-reguler.png" alt=""><span>Pengembangan Kawasan Strategis - Reguler</span></div>
      <div class="legend-item"><img src="images/icon-kawasan-masyarakat.png" alt=""><span>Pengembangan Kawasan Strategis - Berbasis Masyarakat</span></div>
    </div>
  </div>

  <footer class="site-footer" role="contentinfo">
    <div class="footer-inner">
      <div class="footer-brand">
        <div class="logo">MalukuInfraZone</div>
        <div class="tag" style="color:var(--muted)">BPBPK Maluku</div>
        <div class="footer-note">Balai Penataan Bangunan, Prasarana dan Kawasan Maluku</div>
      </div>

      <div class="footer-col">
        <h4>Indonesia</h4>
        <div>Jl. D. I. Panjaitan, Uritetu, Kec. Sirimau</div>
        <div>Kota Ambon, Maluku</div>
      </div>

      <div class="footer-col">
        <h4>Follow us</h4>
        <nav aria-label="Sosial media">
          <ul class="footer-links" style="display:flex;gap:10px;align-items:center">
            <li style="display:inline-flex;align-items:center;gap:8px">
              <a href="https://www.instagram.com/pu_ciptakarya_maluku" target="_blank" rel="noopener noreferrer" aria-label="Instagram BPBPK Maluku" style="display:inline-flex;align-items:center;gap:10px;color:inherit;text-decoration:none">
                <img src="images/instagram.png" alt="" style="width:18px;height:18px;display:block;flex-shrink:0" />
                <span>Instagram</span>
              </a>
            </li>
          </ul>
        </nav>
      </div>
    </div>

    <div class="footer-bottom">© 2025 Balai Penataan Bangunan, Prasarana dan Kawasan Maluku. Semua hak dilindungi.</div>
  </footer>

  <div class="goto-top" id="gotoTop" title="Kembali ke atas"><span>↑</span></div>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    // Config
    const RAW_GEOJSON = "https://raw.githubusercontent.com/bpbpkmaluku/Peta-Infrastruktur/main/data/DATA_SPASIAL.geojson";
    const ADMIN_PROV_URL = "data/maluku_prov.geojson";
    const ADMIN_KAB_URL  = "data/maluku_kabkota.geojson";

    const iconMap = {
      "Air Minum|Reguler": "images/icon-air-reguler.png",
      "Air Minum|Berbasis Masyarakat": "images/icon-air-masyarakat.png",
      "Sanitasi|Reguler": "images/icon-sanitasi-reguler.png",
      "Sanitasi|Berbasis Masyarakat": "images/icon-sanitasi-masyarakat.png",
      "Pengembangan Kawasan Strategis|Reguler": "images/icon-kawasan-reguler.png",
      "Pengembangan Kawasan Strategis|Berbasis Masyarakat": "images/icon-kawasan-masyarakat.png",
      "Bina Penataan Bangunan": "images/icon-bina.png",
      "Pengembangan Kawasan Strategis": "images/icon-kawasan.png",
      "default": "images/icon-default.png"
    };

    let map, infoWindow, allMarkers = [], geoData = null;
    const uniqueSectors = new Set(), uniqueYears = new Set(), uniqueRegions = new Set();

    // Utilities
    function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[c]); }
    function setStatus(t){ document.getElementById('status').textContent = t || ''; }

    function normalizeRegion(s){
      if(!s) return '';
      s = String(s).normalize('NFKC').replace(/\u00A0/g,' ').trim().replace(/\s+/g,' ');
      s = s.replace(/^kab(?:\.|upaten)?\s*/i,'Kab. ');
      s = s.replace(/^kota\s*/i,'Kota ');
      s = s.replace(/^prov(?:\.|insi)?\s*/i,'Prov. ');
      s = s.replace(/^maluku\s*tengah$/i,'Kab. Maluku Tengah');
      s = s.replace(/^kota\s+ambon$/i,'Kota Ambon');
      s = s.replace(/^kota\s+tual$/i,'Kota Tual');
      return s.split(' ').map(w=>w.charAt(0).toUpperCase()+w.slice(1).toLowerCase()).join(' ');
    }

    function formatCurrency(val){
      if(val === undefined || val === null) return '';
      const s = String(val).replace(/\s+/g,'').replace(/Rp|rp|,/g,'').replace(/\./g,'');
      const num = Number(s);
      if(!isFinite(num)) return String(val).trim();
      return 'Rp ' + num.toLocaleString('id-ID');
    }

    function normalizeProperties(props){
      const out = {}; if(!props) return out;
      Object.keys(props).forEach(k => { out[k] = props[k]; });

      function getVal(names){
        for(const n of names){
          if(props[n] !== undefined && props[n] !== null && String(props[n]).trim() !== '') return String(props[n]).trim();
        }
        for(const key in props){
          const lk = key.toLowerCase().replace(/\s+/g,'_');
          for(const n of names){
            if(lk === n.toLowerCase().replace(/\s+/g,'_') && props[key] !== undefined && String(props[key]).trim() !== '') return String(props[key]).trim();
          }
        }
        return '';
      }

      out.Sektor = getVal(['Sektor','sektor','sector']);
      out.Nama_Infrastruktur = getVal(['Nama Infrastruktur','Nama_Infrastruktur','nama_infrastruktur','nama','name']);
      out.Jenis_Kegiatan = getVal(['Jenis Kegiatan','Jenis_Kegiatan','jenis','sub_kelas','subkelas']);
      out.Lokasi = getVal(['Lokasi','lokasi','location','alamat','address','alamat_lengkap']);
      out.Wilayah = getVal(['Wilayah','wilayah','WADMKK','NAMOBJ','kabupaten','kota','kec']);
      out.Tahun_Pembangunan = getVal(['Tahun Pembangunan','Tahun_Pembangunan','tahun_bangun','tahun']);
      out.Status_Keberfungsian = getVal(['Status Keberfungsian','Status_Keberfungsian','status','kondisi']);

      out.Realisasi_Anggaran = getVal(['Realisasi Anggaran','Realisasi_Anggaran','realisasi_anggaran','anggaran','realisasi']);
      out.Tahun_Optimalisasi = getVal([
        'Tahun Optimalisasi','Tahun_Optimalisasi','tahun_optimalisasi','tahun_opt',
        'Tahun Optimaslisasi','Tahun_Optimaslisasi'
      ]);

      if(String(out.Realisasi_Anggaran).trim() === '-') out.Realisasi_Anggaran = '';
      if(String(out.Tahun_Optimalisasi).trim() === '-') out.Tahun_Optimalisasi = '';

      out.Wilayah = normalizeRegion(out.Wilayah || '');

      const raw = (out.Status_Keberfungsian || '').normalize('NFKC').replace(/\u00A0/g,' ').trim();
      const s = raw.toLowerCase();
      if(/^(berfungsi|baik|operasional)$/.test(s)) out.Status_Keberfungsian = 'Berfungsi';
      else if(/^(belum\s*berfungsi|belum|perencanaan|rencana|planned|prepared)$/.test(s)) out.Status_Keberfungsian = 'Belum Berfungsi';
      else if(/(tidak\s*berfungsi|tidakberfungsi|tidak\s*berfungi|tidak\s*diketahui|rusak|mati|off|non[\-\s]?operasional)/.test(s)) out.Status_Keberfungsian = 'Tidak Berfungsi';
      else out.Status_Keberfungsian = raw || '';
      return out;
    }

    function buildInfoHtml(p){
      function find(names){
        for(const n of names){
          if(p[n] !== undefined && p[n] !== null && String(p[n]).trim() !== '') return p[n];
        }
        for(const key in p){
          const lk = key.toLowerCase().replace(/\s+/g,'_');
          for(const n of names){
            if(lk === n.toLowerCase().replace(/\s+/g,'_') && p[key] !== undefined && String(p[key]).trim() !== '') return p[key];
          }
        }
        return '';
      }

      const nama = String(find(['Nama_Infrastruktur','Nama Infrastruktur','nama','name']) || '').trim();
      const sektor = String(find(['Sektor','sektor','sector']) || '').trim();
      const jenis = String(find(['Jenis_Kegiatan','Jenis Kegiatan','jenis','sub_kelas','subkelas']) || '').trim();
      const lokasi = String(find(['Lokasi','lokasi','location','alamat','address','alamat_lengkap']) || '').trim();
      const wilayah = String(find(['Wilayah','wilayah','WADMKK','NAMOBJ','kabupaten','kota','kec']) || '').trim();
      const tahun = String(find(['Tahun_Pembangunan','Tahun Bangun','tahun_bangun','tahun']) || '').trim();
      const status = String(find(['Status_Keberfungsian','Status Keberfungsian','status','kondisi']) || '').trim();

      const realAngRaw = String(find(['Realisasi_Anggaran','Realisasi Anggaran','realisasi_anggaran','anggaran','realisasi']) || '').trim();
      const thOptimalRaw = String(find(['Tahun_Optimalisasi','Tahun Optimalisasi','tahun_optimalisasi','tahun_opt']) || '').trim();

      const realAng = realAngRaw ? formatCurrency(realAngRaw) : '';
      const thOptimal = (thOptimalRaw && thOptimalRaw !== '-') ? thOptimalRaw : '';

      let html = '<div class="custom-iw">';
      if(nama) html += '<div><strong>'+escapeHtml(nama)+'</strong></div>';
      if(sektor) html += '<div>Sektor: '+escapeHtml(sektor)+'</div>';
      if(jenis) html += '<div>Jenis Kegiatan: '+escapeHtml(jenis)+'</div>';
      if(lokasi) html += '<div>Lokasi: '+escapeHtml(lokasi)+'</div>';
      if(wilayah) html += '<div>Wilayah: '+escapeHtml(wilayah)+'</div>';
      if(tahun) html += '<div>Tahun Bangun: '+escapeHtml(tahun)+'</div>';
      if(status) html += '<div>Status: '+escapeHtml(status)+'</div>';
      if(realAng) html += '<div>Realisasi Anggaran: '+escapeHtml(realAng)+'</div>';
      if(thOptimal) html += '<div>Tahun Optimalisasi: '+escapeHtml(thOptimal)+'</div>';
      html += '</div>';
      return html;
    }

    function clearMarkers(){ allMarkers.forEach(x=>x.marker.setMap(null)); allMarkers = []; }

    function createMarkersFromGeo(geo){
      clearMarkers();
      if(!geo || !Array.isArray(geo.features)) return 0;
      const bounds = new google.maps.LatLngBounds();

      geo.features.forEach(f=>{
        if(!f.geometry || f.geometry.type !== 'Point') return;
        const c = f.geometry.coordinates;
        if(!Array.isArray(c) || c.length < 2) return;
        const lng = Number(c[0]), lat = Number(c[1]);
        if(!isFinite(lat) || !isFinite(lng)) return;

        const props = normalizeProperties(f.properties || {});
        const sectorName = props.Sektor ? String(props.Sektor).trim() : '';
        const jenis = props.Jenis_Kegiatan ? String(props.Jenis_Kegiatan).trim() : '';
        let iconUrl = iconMap['default'];

        if (['Air Minum', 'Sanitasi', 'Pengembangan Kawasan Strategis'].includes(sectorName)) {
          const key = sectorName + '|' + (jenis || 'Reguler');
          iconUrl = iconMap[key] || iconMap[sectorName + '|Reguler'] || iconMap[sectorName] || iconMap['default'];
        } else {
          iconUrl = iconMap[sectorName] || iconMap['default'];
        }

        const marker = new google.maps.Marker({
          position: {lat, lng},
          map,
          title: props.Nama_Infrastruktur || props.Nama || '',
          icon: { url: iconUrl, scaledSize: new google.maps.Size(36,36) }
        });

        marker.addListener('click', ()=>{
          const targetZoom = 14;
          map.panTo(marker.getPosition());
          const currentZoom = map.getZoom();
          if(currentZoom < targetZoom){
            setTimeout(()=> map.setZoom(targetZoom), 250);
            setTimeout(()=> { infoWindow.setContent(buildInfoHtml(props)); infoWindow.open(map, marker); }, 500);
          } else {
            infoWindow.setContent(buildInfoHtml(props));
            infoWindow.open(map, marker);
          }
        });

        allMarkers.push({marker, props});
        bounds.extend(marker.getPosition());
      });

      if(!bounds.isEmpty()) map.fitBounds(bounds);
      return allMarkers.length;
    }

    function populateFilters(geo){
      uniqueSectors.clear(); uniqueYears.clear(); uniqueRegions.clear();
      const uniqueJenis = new Set();
      const uniqueStatus = new Set();
      if(!geo || !Array.isArray(geo.features)) return;

      geo.features.forEach(f=>{
        const p = normalizeProperties(f.properties || {});
        if(p.Sektor) uniqueSectors.add(String(p.Sektor).trim());
        if(p.Tahun_Pembangunan && !isNaN(Number(p.Tahun_Pembangunan))) uniqueYears.add(String(p.Tahun_Pembangunan).trim());
        if(p.Wilayah) uniqueRegions.add(String(p.Wilayah).trim());
        if(p.Sektor && (String(p.Sektor).trim() === 'Air Minum' || String(p.Sektor).trim() === 'Sanitasi' || String(p.Sektor).trim() === 'Pengembangan Kawasan Strategis') && p.Jenis_Kegiatan) uniqueJenis.add(String(p.Jenis_Kegiatan).trim());
        if(p.Status_Keberfungsian) uniqueStatus.add(String(p.Status_Keberfungsian).trim());
      });

      document.getElementById('sectorFilter').innerHTML = '<option value="">Semua</option>' + Array.from(uniqueSectors).sort().map(s=>'<option>'+escapeHtml(s)+'</option>').join('');
      document.getElementById('yearFilter').innerHTML = '<option value="">Semua</option>' + Array.from(uniqueYears).sort((a,b)=>Number(a)-Number(b)).map(y=>'<option>'+escapeHtml(y)+'</option>').join('');
      document.getElementById('regionFilter').innerHTML = '<option value="">Semua</option>' + Array.from(uniqueRegions).sort().map(r=>'<option>'+escapeHtml(r)+'</option>').join('');
      document.getElementById('jenisFilter').innerHTML = '<option value="">Semua</option>' + Array.from(uniqueJenis).sort().map(j=>'<option>'+escapeHtml(j)+'</option>').join('');

      const ordered = ['Berfungsi','Belum Berfungsi','Tidak Berfungsi','Tidak Diketahui'];
      const statusSet = new Set(Array.from(uniqueStatus).map(s=>String(s||'').trim()).filter(Boolean));
      const lowerSet = new Set(Array.from(statusSet).map(s=>s.toLowerCase()));
      ordered.forEach(s=>{
        if(lowerSet.has(s.toLowerCase())) statusSet.add(s);
      });
      const statusOptions = Array.from(statusSet).sort((a,b)=>{
        const ia = ordered.indexOf(a), ib = ordered.indexOf(b);
        if(ia !== -1 && ib !== -1) return ia - ib;
        if(ia !== -1) return -1;
        if(ib !== -1) return 1;
        return a.localeCompare(b);
      });
      document.getElementById('statusFilter').innerHTML = '<option value="">Semua</option>' + statusOptions.map(s=>'<option>'+escapeHtml(s)+'</option>').join('');
    }

    function applyFilter(){
      const sector = document.getElementById('sectorFilter').value.trim();
      const year = document.getElementById('yearFilter').value.trim();
      const region = document.getElementById('regionFilter').value.trim();
      const jenis = document.getElementById('jenisFilter').value.trim();
      const status = document.getElementById('statusFilter').value.trim();
      let visible = 0;

      allMarkers.forEach(({marker, props})=>{
        const mSector = props.Sektor ? String(props.Sektor).trim() : '';
        const mYear = props.Tahun_Pembangunan ? String(props.Tahun_Pembangunan).trim() : '';
        const mRegion = props.Wilayah ? String(props.Wilayah).trim() : '';
        const mJenis = props.Jenis_Kegiatan ? String(props.Jenis_Kegiatan).trim() : '';
        const mStatus = props.Status_Keberfungsian ? String(props.Status_Keberfungsian).trim() : '';
        const match = !sector || mSector === sector;
        const matchY = !year || mYear === year;
        const matchR = !region || mRegion === region;
        const matchJ = !jenis || mJenis === jenis;
        const matchS = !status || mStatus === status;
        if(match && matchY && matchR && matchJ && matchS){ marker.setMap(map); visible++; } else { marker.setMap(null); }
      });

      setStatus('Menampilkan ' + visible + ' titik.');
      if(visible > 0){
        const b = new google.maps.LatLngBounds();
        allMarkers.filter(m=>m.marker.getMap()).forEach(m=>b.extend(m.marker.getPosition()));
        if(!b.isEmpty()) map.fitBounds(b);
      }
    }

    function resetFilter(){
      document.getElementById('sectorFilter').value = '';
      document.getElementById('yearFilter').value = '';
      document.getElementById('regionFilter').value = '';
      document.getElementById('jenisFilter').value = '';
      document.getElementById('statusFilter').value = '';
      allMarkers.forEach(x=>x.marker.setMap(map));
      setStatus('Menampilkan ' + allMarkers.length + ' titik.');
      const b = new google.maps.LatLngBounds();
      allMarkers.forEach(x=>b.extend(x.marker.getPosition()));
      if(!b.isEmpty()) map.fitBounds(b);
    }

    async function loadGeoJSON(url){
      setStatus('Memuat: ' + url);
      const r = await fetch(url);
      if(!r.ok) throw new Error('HTTP ' + r.status);
      return await r.json();
    }

    function csvTextToGeoJSON(text, delimiter=','){
      const parsed = Papa.parse(text, {delimiter: delimiter, header: true, skipEmptyLines: true});
      const features = parsed.data.map(row=>{
        const lon = Number((row.Longitude||row.lon||row.Long||row.X||row.x||'').toString().trim());
        const lat = Number((row.Latitude||row.lat||row.Y||row.y||'').toString().trim());
        const props = Object.assign({}, row);
        delete props.Longitude; delete props.Latitude; delete props.lon; delete props.lat; delete props.X; delete props.Y;
        if(!isFinite(lat) || !isFinite(lon)) return null;
        return { type: "Feature", geometry: { type: "Point", coordinates: [lon, lat] }, properties: props };
      }).filter(Boolean);
      return { type: "FeatureCollection", features };
    }

    async function loadSpatialData(url){
      setStatus('Memuat: ' + url);
      const r = await fetch(url);
      if(!r.ok) throw new Error('HTTP ' + r.status);
      const ct = r.headers.get('content-type') || '';
      const text = await r.text();
      if(ct.includes('application/json') || text.trim().startsWith('{') || text.trim().startsWith('[')){
        try { return JSON.parse(text); } catch(e){}
      }
      const semCount = (text.match(/;/g)||[]).length;
      const commaCount = (text.match(/,/g)||[]).length;
      const delimiter = semCount > commaCount ? ';' : ',';
      return csvTextToGeoJSON(text, delimiter);
    }

    function refreshAdminStyle(){
      map.data.setStyle(f=>{
        const maybe = (f.getProperty ? (String(f.getProperty('provinsi')||'') + String(f.getProperty('LEVEL')||'') + String(f.getProperty('NAME')||'') + String(f.getProperty('NAMOBJ')||'')) : '').toLowerCase();
        if(maybe.includes('prov') || maybe.includes('maluku')) return {strokeWeight:2.8, strokeColor:'#FFD166', strokeOpacity:.95, fillColor:'#FFD166', fillOpacity:.02};
        return {strokeWeight:1.4, strokeColor:'#2EC4B6', strokeOpacity:.9, fillColor:'#2EC4B6', fillOpacity:.01};
      });
    }

    function attachAdminInteractions(){
      map.data.addListener('mouseover', e => { map.data.revertStyle(); map.data.overrideStyle(e.feature, { strokeWeight:3.6, strokeOpacity:1, fillOpacity:.04 }); });
      map.data.addListener('mouseout', ()=> map.data.revertStyle());
      map.data.addListener('click', e => {
        const props = e.feature.getProperties() || {};
        const name = props.NAMOBJ || props.WADMKK || props.NAME || props.NAMA || 'Wilayah';
        const content = '<div class="custom-iw"><div><strong>' + escapeHtml(name) + '</strong></div></div>';
        infoWindow.setContent(content);
        infoWindow.setPosition(e.latLng);
        infoWindow.open(map);
      });
    }

    async function initMap(){
      map = new google.maps.Map(document.getElementById('map'), { center:{lat:-3.3,lng:129.1}, zoom:7, mapTypeControl:false, streetViewControl:false });
      infoWindow = new google.maps.InfoWindow({ maxWidth:320, pixelOffset: new google.maps.Size(0, -25) });

      document.getElementById('applyBtn').addEventListener('click', applyFilter);
      document.getElementById('resetBtn').addEventListener('click', resetFilter);

      try {
        const geoMarkers = await loadSpatialData(RAW_GEOJSON);
        geoData = geoMarkers;
        createMarkersFromGeo(geoMarkers);
        populateFilters(geoMarkers);
        resetFilter();
      } catch(e){
        console.error(e);
        setStatus('Gagal muat DATA_SPASIAL. Cek URL atau format file.');
      }

      try{ map.data.addGeoJson(await loadGeoJSON(ADMIN_KAB_URL)); } catch(e){ /* ignore */ }
      try{ map.data.addGeoJson(await loadGeoJSON(ADMIN_PROV_URL)); } catch(e){ /* ignore */ }

      refreshAdminStyle();
      attachAdminInteractions();
    }

    // UI helpers
    const goto = document.getElementById('gotoTop');
    goto.addEventListener('click', ()=>window.scrollTo({top:0,behavior:'smooth'}));
    window.addEventListener('scroll', ()=>{ goto.style.display = window.scrollY>200 ? 'flex' : 'none'; });
    goto.style.display = 'none';

    // Load Google Maps then init
    function loadGoogleMapsThenInit(apiKey){
      if(window.google && google.maps && typeof initMap === 'function'){ try{ initMap(); }catch(e){ console.error(e); } return; }
      const s = document.createElement('script');
      s.src = 'https://maps.googleapis.com/maps/api/js?key=' + encodeURIComponent(apiKey) + '&callback=initMap';
      s.async = true; s.defer = true;
      s.onerror = function(e){ console.error('Failed to load Google Maps script', e); };
      document.head.appendChild(s);
    }

    loadGoogleMapsThenInit('AIzaSyBEZqcze-RGCcRGIBjyEt0-ID99TCDJeS0');
    window.initMap = initMap;
  </script>
</body>
</html>
