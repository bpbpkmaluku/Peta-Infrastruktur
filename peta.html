<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Peta Infrastruktur - MalukuInfraZone</title>
<link rel="icon" type="image/png" href="images/favicon.png">

<!-- Fonts: Raleway + Poppins -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Raleway:wght@300;400;600;700;800&family=Poppins:wght@300;400;600;800&display=swap" rel="stylesheet">

<style>
:root{--bg:#071024;--muted:#a7b6c8;--accent:#3b82f6}
html,body{
height:100%;margin:0;
font-family:"Poppins",system-ui,Segoe UI,Roboto,Arial;
background:linear-gradient(180deg,var(--bg),#05060a);
color:#fff;
}

.wrap{max-width:1400px;margin:20px auto;padding:20px;text-align:center}
header{display:flex;justify-content:space-between;align-items:center;gap:12px;text-align:left}
.title{font-weight:700;font-family:"Raleway",Poppins,system-ui,Segoe UI,Roboto,Arial}
.btn{display:inline-block;padding:8px 14px;border-radius:8px;text-decoration:none;font-weight:700;cursor:pointer}
.btn-back{background:rgba(255,255,255,0.04);color:#e6eef7;border:1px solid rgba(255,255,255,0.08)}
.controls{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
.select-wrap{position:relative;display:inline-block}
.select{
background:#ffffff;color:#021129;padding:8px 12px;border-radius:8px;
border:1px solid var(--accent);min-width:160px;font-weight:600;appearance:none;
}
.select-wrap::after{
content:"";position:absolute;right:10px;top:50%;transform:translateY(-50%);
width:0;height:0;border-left:6px solid transparent;border-right:6px solid transparent;
border-top:8px solid #021129;pointer-events:none
}
select::-ms-expand{display:none}

/* MAP */
#map{width:100%;height:85vh;border-radius:12px;background:#0b1220;
box-shadow:0 10px 30px rgba(0,0,0,0.6);margin-top:14px;display:block}
.status{margin-top:8px;color:var(--muted);font-size:13px}

/* LEGEND */
.legend{display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:center;margin-top:12px;
padding:10px 12px;background:rgba(0,0,0,0.45);border-radius:10px;
box-shadow:0 6px 18px rgba(0,0,0,0.45);z-index:9999;position:relative}
.legend-item{display:flex;align-items:center;gap:8px;padding:6px 8px;
background:rgba(255,255,255,0.02);border-radius:8px;font-size:14px;color:#e6eef7}
.legend-item img{width:28px;height:28px;object-fit:contain;filter:drop-shadow(0 3px 6px rgba(0,0,0,0.4))}

/* InfoWindow adjustments */
.gm-style .gm-style-iw { padding:0!important; margin:0!important; max-width:320px!important; box-shadow:none!important; }
.gm-style .gm-style-iw > div, .gm-style .gm-style-iw-d, .gm-style .gm-style-iw-c { padding:0!important; margin:0!important; }
.gm-ui-hover-effect{
width:22px!important;height:22px!important;top:6px!important;right:6px!important;
border-radius:6px!important;background:rgba(0,0,0,0.06)!important;
display:flex!important;align-items:center!important;justify-content:center!important;
border:1px solid rgba(0,0,0,0.08)!important;box-shadow:0 1px 2px rgba(0,0,0,0.05)!important;
}
.gm-ui-hover-effect > span, .gm-ui-hover-effect svg, .gm-ui-hover-effect img {
width:12px!important;height:12px!important;transform:none!important;display:block!important;margin:0!important;
}
.custom-iw{
font-size:13px;color:#021129;background:#fff;padding:8px;border-radius:6px;max-width:320px;text-align:left;line-height:1.4;
}
.custom-iw > div{margin:0;padding:0}

/* Hero below */
.site-hero{margin-top:28px;text-align:center}
.hero-logo{font-weight:800;font-size:28px;color:#fff;font-family:"Raleway",Poppins,system-ui}
.hero-title{font-weight:600;font-size:24px;line-height:1.3;margin:8px 0;color:#fff}
.hero-sub{color:var(--muted);font-size:15px;margin-top:6px}

/* Footer: centered */
.site-footer{background:#050505;color:#d1d5db;padding:36px 20px;margin-top:20px;border-radius:8px;text-align:center}
.footer-inner{max-width:1200px;margin:0 auto;display:flex;gap:40px;justify-content:center;align-items:flex-start;flex-wrap:wrap;text-align:center}
.footer-brand,.footer-col{flex:1 1 300px;min-width:220px}
.footer-brand .logo{font-weight:800;font-size:28px;color:#fff;margin-bottom:6px;font-family:"Raleway",Poppins}
.footer-note{color:#9ca3af;font-size:14px;line-height:1.6}
.footer-col h4{color:#fff;font-weight:700;margin-bottom:12px;font-size:16px}
.footer-links{display:flex;flex-direction:column;gap:8px;margin:0;padding:0;list-style:none;align-items:center}
.footer-links a{color:#9ca3af;text-decoration:none;font-size:15px;line-height:1.6}
.footer-links a:hover{color:#fff}

.goto-top{position:fixed;right:20px;bottom:28px;width:44px;height:44px;border-radius:22px;background:#111;color:#fff;display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 6px 18px rgba(0,0,0,0.4)}
.goto-top span{font-size:18px}

@media(max-width:900px){
#map{height:65vh}
.controls{flex-direction:column;align-items:flex-start}
.footer-inner{gap:20px;justify-content:center}
.footer-brand,.footer-col{flex:1 1 100%}
.hero-title{font-size:20px}
}
</style>
</head>
<body>
<div class="wrap">
<header>
<div>
<div class="title">Peta Infrastruktur â€” MalukuInfraZone</div>
<div style="font-size:13px;color:var(--muted)">BPBPK Maluku</div>
</div>
<div class="controls" aria-hidden="false">
<a href="index.html" class="btn btn-back">Kembali</a>
</div>
</header>

<!-- Filters -->
<div style="margin-top:12px;display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:center">
<label style="font-size:13px;color:var(--muted)">Sektor</label>
<div class="select-wrap"><select id="sectorFilter" class="select"></select></div>
<label style="font-size:13px;color:var(--muted)">Wilayah</label>
<div class="select-wrap"><select id="regionFilter" class="select"></select></div>
<label style="font-size:13px;color:var(--muted)">Tahun</label>
<div class="select-wrap"><select id="yearFilter" class="select"></select></div>
<label style="font-size:13px;color:var(--muted)">Jenis Kegiatan</label>
<div class="select-wrap"><select id="jenisFilter" class="select"></select></div>
      <label style="font-size:13px;color:var(--muted)">Status Keberfungsian</label>
      <div class="select-wrap"><select id="statusFilter" class="select"></select></div>
<button id="applyBtn" class="btn" style="background:var(--accent);color:#021129">Terapkan</button>
<button id="resetBtn" class="btn btn-back">Reset</button>
</div>

<div id="map"></div>
<div class="status" id="status">Memuat peta...</div>

<!-- Load Google Maps JS API as usual with your API key -->
<script src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&callback=initMap" async defer></script>

<script>
// Configuration URLs
const RAW_GEOJSON = "https://raw.githubusercontent.com/bpbpkmaluku/Peta-Infrastruktur/main/data/DATA_SPASIAL.geojson";
const ADMIN_PROV_URL = "data/maluku_prov.geojson";
const ADMIN_KAB_URL  = "data/maluku_kabkota.geojson";

let map;
let infoWindow;
let allMarkers = []; // { marker, props }
let geoData = null;

function setStatus(t){ const el = document.getElementById('status'); if(el) el.textContent = t; }

function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;" })[c]); }

function normalizeRegion(v){ return String(v||'').trim(); }

function normalizeProperties(input){
  const out = {};
  Object.keys(input||{}).forEach(k=>{
    const lower = k.toLowerCase();
    const v = input[k];
    if(['sektor','sector'].includes(lower)) out.Sektor = v;
    if(['tahun_pembangunan','tahun','year'].includes(lower)) out.Tahun_Pembangunan = v;
    if(['wilayah','region'].includes(lower)) out.Wilayah = v;
    if(['jenis_kegiatan','jenis','subkelas','sub_kelas'].includes(lower)) out.Jenis_Kegiatan = v;
    if(['status_keberfungsian','status','keberfungsian'].includes(lower)) out.Status_Keberfungsian = v;
  });
  out.Wilayah = normalizeRegion(out.Wilayah || '');
  if(out.Status_Keberfungsian){
    const s = String(out.Status_Keberfungsian||'').trim().toLowerCase();
    if(/berfungsi|baik|operasional/.test(s)) out.Status_Keberfungsian = 'Berfungsi';
    else if(/tidak\s*berfungsi|rusak|mati|off|non-operasional/.test(s)) out.Status_Keberfungsian = 'Tidak Berfungsi';
    else if(/belum\s*berfungsi|belum|perencanaan|rencana|prepared|planned/.test(s)) out.Status_Keberfungsian = 'Belum Berfungsi';
    else out.Status_Keberfungsian = String(out.Status_Keberfungsian).trim();
  }
  return out;
}

// Minimal default icon map. Replace with full assets as needed.
const iconMap = {
  'default': 'images/marker-default.png',
  'Air Minum|Reguler': 'images/icon-air-reguler.png',
  'Air Minum|Sumur': 'images/icon-air-sumur.png',
  'Sanitasi|Reguler': 'images/icon-sanitasi-reguler.png'
};

function getIconForFeature(props){
  const sectorName = props.Sektor ? String(props.Sektor).trim() : '';
  const jenis = props.Jenis_Kegiatan ? String(props.Jenis_Kegiatan).trim() : '';
  if(sectorName === 'Air Minum' || sectorName === 'Sanitasi'){
    const key = sectorName + '|' + (jenis || 'Reguler');
    return iconMap[key] || iconMap['default'];
  }
  return iconMap['default'];
}

function createMarkersFromGeo(geo){
  if(!geo || !Array.isArray(geo.features)) return;
  // clear old
  allMarkers.forEach(x=>x.marker.setMap(null));
  allMarkers = [];

  geo.features.forEach(f=>{
    const coords = (f.geometry && f.geometry.coordinates) ? f.geometry.coordinates.slice() : null;
    if(!coords) return;
    // GeoJSON coordinates order: [lng, lat]
    const lng = coords[0];
    const lat = coords[1];
    const props = normalizeProperties(f.properties || {});
    const icon = getIconForFeature(props);
    const marker = new google.maps.Marker({ position:{lat:lat,lng:lng}, map: map, icon: icon });
    marker.addListener('click', ()=>{
      const content = '<div class="custom-iw"><div><strong>' + escapeHtml(props.Sektor || 'Obyek') + '</strong></div>' +
        '<div>' + escapeHtml(props.Jenis_Kegiatan || '') + '</div>' +
        '<div>' + escapeHtml(props.Wilayah || '') + '</div>' +
        '<div>Status: ' + escapeHtml(props.Status_Keberfungsian || '-') + '</div></div>';
      infoWindow.setContent(content);
      infoWindow.setPosition(marker.getPosition());
      infoWindow.open(map);
    });
    allMarkers.push({ marker, props });
  });
}

function populateFilters(geo){
  const uniqueSectors = new Set();
  const uniqueYears = new Set();
  const uniqueRegions = new Set();
  const uniqueJenis = new Set();
  const uniqueStatus = new Set();
  if(!geo || !Array.isArray(geo.features)) return;
  geo.features.forEach(f=>{
    const p = normalizeProperties(f.properties || {});
    if(p.Sektor) uniqueSectors.add(String(p.Sektor).trim());
    if(p.Tahun_Pembangunan && !isNaN(Number(p.Tahun_Pembangunan))) uniqueYears.add(String(p.Tahun_Pembangunan).trim());
    if(p.Wilayah) uniqueRegions.add(String(p.Wilayah).trim());
    if(p.Sektor && (String(p.Sektor).trim() === 'Air Minum' || String(p.Sektor).trim() === 'Sanitasi') && p.Jenis_Kegiatan) uniqueJenis.add(String(p.Jenis_Kegiatan).trim());
    if(p.Status_Keberfungsian) uniqueStatus.add(String(p.Status_Keberfungsian).trim());
  });
  document.getElementById('sectorFilter').innerHTML = '<option value="">Semua</option>' + Array.from(uniqueSectors).sort().map(s=>'<option>'+escapeHtml(s)+'</option>').join('');
  document.getElementById('yearFilter').innerHTML = '<option value="">Semua</option>' + Array.from(uniqueYears).sort((a,b)=>Number(a)-Number(b)).map(y=>'<option>'+escapeHtml(y)+'</option>').join('');
  document.getElementById('regionFilter').innerHTML = '<option value="">Semua</option>' + Array.from(uniqueRegions).sort().map(r=>'<option>'+escapeHtml(r)+'</option>').join('');
  document.getElementById('jenisFilter').innerHTML = '<option value="">Semua</option>' + Array.from(uniqueJenis).sort().map(j=>'<option>'+escapeHtml(j)+'</option>').join('');
  const ordered = ['Berfungsi','Belum Berfungsi','Tidak Berfungsi'];
  const statusOptions = ordered.filter(s=>uniqueStatus.has(s)).concat(Array.from(uniqueStatus).filter(s=>!ordered.includes(s)).sort());
  document.getElementById('statusFilter').innerHTML = '<option value="">Semua</option>' + statusOptions.map(s=>'<option>'+escapeHtml(s)+'</option>').join('');
}

function applyFilter(){
  const sector = document.getElementById('sectorFilter').value.trim();
  const year = document.getElementById('yearFilter').value.trim();
  const region = document.getElementById('regionFilter').value.trim();
  const jenis = document.getElementById('jenisFilter').value.trim();
  const status = document.getElementById('statusFilter').value.trim();
  let visible = 0;
  allMarkers.forEach(({marker, props})=>{
    const mSector = props.Sektor ? String(props.Sektor).trim() : '';
    const mYear = props.Tahun_Pembangunan ? String(props.Tahun_Pembangunan).trim() : '';
    const mRegion = props.Wilayah ? String(props.Wilayah).trim() : '';
    const mJenis = props.Jenis_Kegiatan ? String(props.Jenis_Kegiatan).trim() : '';
    const mStatus = props.Status_Keberfungsian ? String(props.Status_Keberfungsian).trim() : '';
    const match = (!sector || mSector === sector) && (!year || mYear === year) && (!region || mRegion === region) && (!jenis || mJenis === jenis) && (!status || mStatus === status);
    if(match){ marker.setMap(map); visible++; } else { marker.setMap(null); }
  });
  setStatus('Menampilkan ' + visible + ' titik.');
  if(visible > 0){
    const b = new google.maps.LatLngBounds();
    allMarkers.forEach(x=>{ if(x.marker.getMap()) b.extend(x.marker.getPosition()); });
    if(allMarkers.length > 0) map.fitBounds(b);
  }
}

function resetFilter(){
  document.getElementById('sectorFilter').value = '';
  document.getElementById('yearFilter').value = '';
  document.getElementById('regionFilter').value = '';
  document.getElementById('jenisFilter').value = '';
  document.getElementById('statusFilter').value = '';
  allMarkers.forEach(x=>x.marker.setMap(map));
  setStatus('Menampilkan ' + allMarkers.length + ' titik.');
  if(allMarkers.length > 0){
    const b = new google.maps.LatLngBounds();
    allMarkers.forEach(x=>b.extend(x.marker.getPosition()));
    map.fitBounds(b);
  }
}

async function loadGeoJSON(url){
  setStatus('Memuat: ' + url);
  const r = await fetch(url);
  if(!r.ok) throw new Error('HTTP ' + r.status);
  return await r.json();
}

function refreshAdminStyle(){
  map.data.setStyle(f=>{
    const maybe = (f.getProperty ? (String(f.getProperty('provinsi')||'') + String(f.getProperty('LEVEL')||'') + String(f.getProperty('NAME')||'') + String(f.getProperty('NAMOBJ')||'')) : '').toLowerCase();
    if(maybe.includes('prov') || maybe.includes('maluku')) return {strokeWeight:2.8, strokeColor:'#FFD166', strokeOpacity:.95, fillColor:'#FFD166', fillOpacity:.02};
    return {strokeWeight:1.4, strokeColor:'#2EC4B6', strokeOpacity:.9, fillColor:'#2EC4B6', fillOpacity:.01};
  });
}

function attachAdminInteractions(){
  map.data.addListener('mouseover', e => { map.data.revertStyle(); map.data.overrideStyle(e.feature, { strokeWeight:3.6, strokeOpacity:1, fillOpacity:.04 }); });
  map.data.addListener('mouseout', ()=> map.data.revertStyle());
  map.data.addListener('click', e => {
    const props = e.feature.getProperties();
    const name = props.NAMOBJ || props.WADMKK || props.NAME || props.NAMA || 'Wilayah';
    const content = '<div class="custom-iw"><div><strong>' + escapeHtml(name) + '</strong></div></div>';
    infoWindow.setContent(content);
    infoWindow.setPosition(e.latLng);
    infoWindow.open(map);
  });
}

async function initMap(){
  map = new google.maps.Map(document.getElementById('map'), { center:{lat:-3.3,lng:129.1}, zoom:7, mapTypeControl:false, streetViewControl:false });
  infoWindow = new google.maps.InfoWindow({ maxWidth:320, pixelOffset: new google.maps.Size(0, -25) });

  document.getElementById('applyBtn').addEventListener('click', applyFilter);
  document.getElementById('resetBtn').addEventListener('click', resetFilter);

  try {
    const geoMarkers = await loadGeoJSON(RAW_GEOJSON);
    geoData = geoMarkers;
    createMarkersFromGeo(geoMarkers);
    populateFilters(geoMarkers);
    resetFilter();
  } catch(e){
    console.error(e);
    setStatus('Gagal muat DATA_SPASIAL.geojson');
  }

  try{ map.data.addGeoJson(await loadGeoJSON(ADMIN_KAB_URL)); } catch(e){ /* ignore */ }
  try{ map.data.addGeoJson(await loadGeoJSON(ADMIN_PROV_URL)); } catch(e){ /* ignore */ }

  refreshAdminStyle();
  attachAdminInteractions();
}

window.initMap = initMap;
</script>
</body>
</html>
