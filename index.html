<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>MalukuInfraZone</title>
  <meta name="description" content="Portal data dan peta infrastruktur BPBPK Maluku">

  <!-- Logo Web -->
  <link rel="icon" type="image/png" href="images/logo-pu.png">

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@400;500;600;700;900&family=Montserrat:wght@400;600;700;900&family=Poppins:wght@300;400;600;800&display=swap" rel="stylesheet">

  <!-- Styles -->
  <style>
    :root {
      --bg-dark: #0b0f17;
      --accent: #3b82f6;
      --accent-2: #f59e0b;
      --muted: #a7b6c8;
      --font-poppins: 'Poppins', sans-serif;
      --font-montserrat: 'Montserrat', sans-serif;
      --font-raleway: 'Raleway', sans-serif;
    }

    html, body {
      height: 100%;
      margin: 0;
      font-family: var(--font-poppins);
      background: var(--bg-dark);
      color: #fff;
      overflow-x: hidden;
      padding-top: 72px; /* ruang untuk header fixed */
    }

    /* ===== Header ===== */
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 18px 36px;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 50;
      background: rgba(11, 15, 23, 0.75);
      backdrop-filter: blur(8px);
      transition: background .3s ease, box-shadow .3s ease;
    }
    header.scrolled {
      background: rgba(11, 15, 23, 0.92);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
    }
    .brand {
      display: flex;
      align-items: center;
      gap: 20px;
    }
    .brand img {
      height: 44px;
    }
    .site-title {
      font-family: var(--font-raleway);
      font-weight: 800;
      font-size: 28px;
    }
    .nav a {
      margin-left: 22px;
      color: #fff;
      text-decoration: none;
      font-weight: 600;
      transition: color .2s;
    }
    .nav a:hover {
      color: var(--accent);
    }

    /* ===== Hero ===== */
    .hero {
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      flex-direction: column;
      position: relative;
      background: url('images/background-maluku.jpg') no-repeat center/cover;
    }
    .hero::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(180deg, rgba(0,0,0,0.6), rgba(0,0,0,0.7));
    }
    .hero-content {
      position: relative;
      z-index: 10;
      max-width: 880px;
      padding: 20px;
    }
    .hero h1 {
      font-size: 52px;
      font-family: var(--font-montserrat);
      font-weight: 900;
      margin: 0;
      letter-spacing: -0.02em;
    }
    .hero p {
      margin-top: 12px;
      color: var(--muted);
      font-size: 18px;
    }
    .btn-primary {
      margin-top: 24px;
      display: inline-block;
      padding: 14px 28px;
      border-radius: 999px;
      font-weight: 700;
      background: var(--accent);
      color: #021129;
      text-decoration: none;
      font-size: 18px;
      transition: transform .18s ease, box-shadow .18s ease;
    }
    .btn-primary:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 26px rgba(59,130,246,0.3);
    }

    /* Fade-in animations */
    .fade-in {
      opacity: 0;
      transform: translateY(8px);
      animation: fadeUp .7s ease forwards;
    }
    .fade-in.delay-1 { animation-delay: .12s; }
    .fade-in.delay-2 { animation-delay: .28s; }
    .fade-in.delay-3 { animation-delay: .44s; }
    @keyframes fadeUp {
      to { opacity: 1; transform: translateY(0); }
    }

    /* ===== Sectors ===== */
    .sectors {
      padding: 80px 20px;
      max-width: 1160px;
      margin: 0 auto;
      text-align: center;
    }
    .sectors h2 {
      font-size: 32px;
      font-family: var(--font-montserrat);
      font-weight: 800;
      margin-bottom: 40px;
    }
    .sector-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 28px;
    }
    .sector-card {
      background: #161b26;
      border-radius: 14px;
      padding: 24px;
      box-shadow: 0 6px 22px rgba(0,0,0,0.45);
      transition: transform .28s, box-shadow .28s;
      opacity: 0;
      transform: translateY(10px);
      animation: cardIn .6s ease forwards;
    }
    .sector-card:nth-child(1){ animation-delay: .12s; }
    .sector-card:nth-child(2){ animation-delay: .24s; }
    .sector-card:nth-child(3){ animation-delay: .36s; }
    .sector-card:nth-child(4){ animation-delay: .48s; }
    @keyframes cardIn {
      to { opacity: 1; transform: translateY(0); }
    }
    .sector-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 18px 40px rgba(0,0,0,0.6);
    }
    .sector-card .icon {
      width: 56px;
      height: 56px;
      display: inline-block;
      margin-bottom: 12px;
      object-fit: contain;
      filter: drop-shadow(0 4px 8px rgba(0,0,0,0.4));
    }
    .sector-card h3 {
      margin: 0 0 10px;
      font-size: 20px;
      font-weight: 700;
      color: var(--accent);
    }
    .sector-card p {
      margin: 0;
      color: var(--muted);
      font-size: 14px;
    }

    /* ===== Footer ===== */
    footer {
      text-align: center;
      padding: 40px;
      color: var(--muted);
      font-size: 14px;
      background: #0b0f17;
    }
    footer .tagline {
      display: block;
      margin-top: 8px;
      font-size: 16px;
      color: #fff;
      font-weight: 600;
    }

    /* ===== Responsive ===== */
    @media(max-width:720px) {
      .hero h1 { font-size: 34px; }
      .hero p { font-size: 16px; }
    }
  </style>
</head>
<body>
  <!-- ===== Header ===== -->
  <header id="site-header">
    <div class="brand">
      <img src="images/favicon.png" alt="Logo MalukuInfraZone">
      <div class="site-title">MalukuInfraZone</div>
    </div>
    <nav class="nav">
      <a href="index.html">Beranda</a>
      <a href="peta.html">Peta Infrastruktur</a>
    </nav>
  </header>

  <!-- ===== Hero Section ===== -->
  <section class="hero">
    <div class="hero-content">
      <h1 class="fade-in delay-1">Platform Digital BPBPK Maluku</h1>
      <p class="fade-in delay-2">Transparansi Data â€” Akses Informasi Infrastruktur Terbangun Balai Penataan Bangunan, Prasarana dan Kawasan Maluku</p>
      <a href="peta.html" class="btn-primary fade-in delay-3">Lihat Peta Infrastruktur</a>
    </div>
  </section>

  <!-- ===== Sectors Section ===== -->
  <section class="sectors">
    <h2>Sektor-Sektor di BPBPK Maluku</h2>
    <div class="sector-list">
      <div class="sector-card">
        <img class="icon" src="images/icon-air.png" alt="Icon Air Minum">
        <h3>Air Minum</h3>
        <p>Menyediakan infrastruktur air minum yang layak untuk masyarakat Maluku.</p>
      </div>
      <div class="sector-card">
        <img class="icon" src="images/icon-sanitasi.png" alt="Icon Sanitasi">
        <h3>Sanitasi</h3>
        <p>Pembangunan dan pengelolaan infrastruktur sanitasi yang mendukung kesehatan lingkungan.</p>
      </div>
      <div class="sector-card">
        <img class="icon" src="images/icon-bina.png" alt="Icon Bina Penataan Bangunan">
        <h3>Bina Penataan Bangunan</h3>
        <p>Pengelolaan tata bangunan dan pengawasan kualitas pembangunan gedung.</p>
      </div>
      <div class="sector-card">
        <img class="icon" src="images/icon-kawasan.png" alt="Icon Pengembangan Kawasan Strategis">
        <h3>Pengembangan Kawasan Strategis</h3>
        <p>Pengembangan kawasan strategis untuk mendukung pertumbuhan wilayah Maluku.</p>
      </div>
    </div>
  </section>

  <!-- START: Dashboard Interaktif Rekap (paste sebelum </body>) -->
<!-- Requires: data/rekap_reguler.json and data/rekap_ibm.json in repo/data -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js/dist/Chart.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<section id="dash-rekap" style="max-width:1160px;margin:40px auto;padding:20px;border-radius:12px;">
  <!-- Header / KPI -->
  <div style="display:flex;flex-wrap:wrap;gap:16px;align-items:center;justify-content:space-between;margin-bottom:18px;">
    <div style="flex:1;min-width:280px">
      <h3 style="margin:0;color:#fff;font-family:var(--font-montserrat);">Rekapitulasi Status Keberfungsian Infrastruktur Terbangun Tahun Anggaran 2020 - 2024</h3>
      <p style="margin:6px 0 0;color:var(--muted);font-size:13px">Sumber: Balai Penataan Bangunan, Prasarana dan Kawasan Permukiman Wilayah Maluku</p>
    </div>

    <div style="display:flex;gap:12px;align-items:center">
      <div style="background:#0b1220;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03)">
        <div style="font-size:12px;color:var(--muted)">Total Investasi</div>
        <div id="kpi-invest" style="font-weight:800;color:#ffd54f">-</div>
      </div>
      <div style="background:#0b1220;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03)">
        <div style="font-size:12px;color:var(--muted)">Total Unit Terbangun</div>
        <div id="kpi-units" style="font-weight:800;color:#fff">-</div>
      </div>
      <div style="background:#0b1220;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);width:120px;text-align:center">
        <div style="font-size:12px;color:var(--muted)">Keberfungsian</div>
        <canvas id="kpi-donut" width="120" height="80"></canvas>
        <div id="kpi-donut-label" style="font-weight:800;color:#88e28f;font-size:13px;margin-top:6px">-</div>
      </div>
    </div>
  </div>

  <!-- Controls: Filter Tahun / Sumber -->
  <div style="display:flex;gap:12px;align-items:center;margin-bottom:16px;flex-wrap:wrap">
    <label style="color:var(--muted);font-size:13px">Tahun:</label>
    <select id="filter-year" style="padding:6px;border-radius:6px;background:transparent;color:#fff;border:1px solid rgba(255,255,255,0.06)"></select>

    <label style="color:var(--muted);font-size:13px">Sumber:</label>
    <select id="filter-source" style="padding:6px;border-radius:6px;background:transparent;color:#fff;border:1px solid rgba(255,255,255,0.06)">
      <option value="gabungan">Gabungan</option>
      <option value="reguler">Reguler</option>
      <option value="ibm">IBM</option>
    </select>

    <label style="margin-left:12px;color:var(--muted);font-size:13px">
      <input type="checkbox" id="toggle-hide-empty" checked style="margin-right:6px"> Sembunyikan Baris Data Kosong
    </label>
  </div>

  <!-- Middle: Charts -->
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:18px;margin-bottom:18px">
    <div style="background:#0f1620;padding:14px;border-radius:10px;border:1px solid rgba(255,255,255,0.04)">
      <div style="color:var(--muted);margin-bottom:8px">Nilai Investasi per Program</div>
      <canvas id="chart-invest" height="240"></canvas>
    </div>

    <div style="background:#0f1620;padding:14px;border-radius:10px;border:1px solid rgba(255,255,255,0.04)">
      <div style="color:var(--muted);margin-bottom:8px">Status Keberfungsian (Berfungsi / Tidak)</div>
      <canvas id="chart-status" height="240"></canvas>
    </div>
  </div>

  <!-- Bottom: Detail Technical Table -->
  <div style="background:#0f1620;padding:14px;border-radius:10px;border:1px solid rgba(255,255,255,0.04)">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <div style="color:var(--muted)">Tabel Detail Teknis</div>
      <div style="color:var(--muted);font-size:13px">Satuan tertampil pada kolom</div>
    </div>

    <div style="overflow:auto">
      <table id="detail-table" style="width:100%;border-collapse:collapse;font-size:13px">
        <thead>
          <tr style="color:var(--muted);text-align:left;border-bottom:1px solid rgba(255,255,255,0.04)">
            <th style="padding:8px">Jenis</th>
            <th style="padding:8px">Program/Sektor</th>
            <th style="padding:8px">Kapasitas Terpasang</th>
            <th style="padding:8px">Kapasitas Terpakai</th>
            <th style="padding:8px">Idle Capacity</th>
            <th style="padding:8px">Luas Penanganan</th>
            <th style="padding:8px">Luas Kawasan</th>
          </tr>
        </thead>
        <tbody id="detail-body"></tbody>
      </table>
    </div>
  </div>
</section>

<!-- Modal drill-down -->
<div id="modal-drill" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:9999">
  <div style="width:820px;max-width:95%;background:#08101a;padding:18px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <div style="font-weight:800;color:#ffd54f" id="modal-title">Detail</div>
      <button id="modal-close" style="background:transparent;border:0;color:var(--muted);font-weight:700;cursor:pointer">Tutup</button>
    </div>
    <div id="modal-body" style="max-height:60vh;overflow:auto;color:#fff;font-size:13px"></div>
  </div>
</div>

<script>
(function(){
  const PATH_REG = 'data/rekap_reguler.json';
  const PATH_IBM = 'data/rekap_ibm.json';

  // charts
  let chartInvest = null, chartStatus = null, donutChart = null;

  // data store
  let dataReg = [], dataIbm = [];

  // helpers
  const $ = sel => document.querySelector(sel);
  const el = tag => document.createElement(tag);
  const fmt = (n, d=2) => {
    if(n===undefined||n===null||n==='-'||n==='') return 'N/A';
    const num = Number(String(n).replace(/[^0-9.-]/g,''));
    if(isNaN(num)) return n;
    return num.toLocaleString('id-ID',{minimumFractionDigits:0,maximumFractionDigits:d});
  };

  function aggregateForCharts(sourceArr, sourceType){
    // returns per-program object for IBM or per-sector for Reguler
    // structure: {key: {label, invest, unitTotal, berfungsi, tidak}}
    const map = {};
    sourceArr.forEach(r=>{
      const key = sourceType==='ibm' ? (r.Program || 'Unknown') : (r.Sektor || r.Sektor || 'Unknown');
      if(!map[key]) map[key] = { label:key, invest:0, unit:0, berfungsi:0, tidak:0, capacities: {tp:0, pakai:0, idle:0}, technical: {} };
      map[key].invest += Number(r['Nilai Investasi (Miliar)']||0);
      map[key].unit += Number(r['Jumlah Unit']||0);
      map[key].berfungsi += Number(r['Berfungsi']||0);
      map[key].tidak += Number(r['Tidak Berfungsi']||0);

      // capacities numeric for KPI
      const parseNum = v => {
        if(!v || v==='-' ) return 0;
        const m = String(v).match(/[-+]?[0-9]*[.,]?[0-9]+/);
        return m ? Number(m[0].replace(',','.')) : 0;
      };
      map[key].capacities.tp += parseNum(r['Kapasitas Terpasang']);
      map[key].capacities.pakai += parseNum(r['Kapasitas Terpakai']);
      map[key].capacities.idle += parseNum(r['Idle Capacity']);

      // keep technical fields (first non-empty)
      ['Luas Penanganan','Luas Kawasan','Satuan Kapasitas'].forEach(f=>{
        if((!map[key].technical[f] || map[key].technical[f]==='-') && r[f] && r[f]!== '-') map[key].technical[f] = r[f];
      });

      // store raw rows for drill-down
      if(!map[key].rows) map[key].rows = [];
      map[key].rows.push(r);
    });
    return Object.values(map);
  }

  // build KPI summary
  function buildKPI(combinedAll){
    const totInvest = combinedAll.reduce((s,i)=>s + Number(i['Nilai Investasi (Miliar)']||0),0);
    const totUnits = combinedAll.reduce((s,i)=>s + Number(i['Jumlah Unit']||0),0);
    const totBerfungsi = combinedAll.reduce((s,i)=>s + Number(i['Berfungsi']||0),0);
    // donut values: berfungsi, tidak
    const totTidak = combinedAll.reduce((s,i)=>s + Number(i['Tidak Berfungsi']||0),0);

    $('#kpi-invest').textContent = totInvest ? 'Rp ' + fmt(totInvest,2) + ' M' : 'N/A';
    $('#kpi-units').textContent = totUnits ? fmt(totUnits,0) : 'N/A';
    const pct = totUnits ? Math.round((totBerfungsi / totUnits) * 100) : 0;
    $('#kpi-donut-label').textContent = pct ? (pct + '%') : 'N/A';

    const ctx = document.getElementById('kpi-donut').getContext('2d');
    if(donutChart) donutChart.destroy();
    donutChart = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: ['Berfungsi','Tidak'],
        datasets: [{ data:[totBerfungsi, totTidak], backgroundColor:['#88e28f','#ff9b8a'], borderWidth:0 }]
      },
      options: {
        plugins:{tooltip:{callbacks:{label:ctx=>{ return ctx.label+': '+fmt(ctx.raw,0); }}}},
        cutout:'70%',
        responsive:true,
        maintainAspectRatio:true
      }
    });
  }

  // build Invest bar chart (horizontal)
  function buildInvestChart(items){
    const labels = items.map(i=>i.label);
    const data = items.map(i=>Number(i.invest || 0));
    const ctx = document.getElementById('chart-invest').getContext('2d');
    if(chartInvest) chartInvest.destroy();
    chartInvest = new Chart(ctx, {
      type: 'bar',
      data: { labels, datasets:[{ label:'Nilai Investasi (Miliar)', data, backgroundColor:'#3b82f6' }]},
      options: {
        indexAxis:'y',
        plugins:{legend:{display:false},tooltip:{callbacks:{label:ctx=> 'Rp '+fmt(ctx.raw,2)+' M | '+items[ctx.dataIndex].unit+' unit'}}},
        responsive:true, maintainAspectRatio:false,
        scales:{x:{ticks:{callback:val=>'Rp '+fmt(val,2)+' M'}}}
      }
    });

    // add click handler to drill-down
    document.getElementById('chart-invest').onclick = function(evt){
      const points = chartInvest.getElementsAtEventForMode(evt,'nearest',{intersect:true},true);
      if(points.length){
        const idx = points[0].index;
        openDrillModal(items[idx]);
      }
    };
  }

  // build stacked bar for Berfungsi vs Tidak
  function buildStatusChart(items){
    const labels = items.map(i=>i.label);
    const dataBer = items.map(i=>Number(i.berfungsi||0));
    const dataTidak = items.map(i=>Number(i.tidak||0));
    const ctx = document.getElementById('chart-status').getContext('2d');
    if(chartStatus) chartStatus.destroy();
    chartStatus = new Chart(ctx, {
      type:'bar',
      data: { labels, datasets:[
        { label:'Berfungsi', data:dataBer, backgroundColor:'#88e28f' },
        { label:'Tidak Berfungsi', data:dataTidak, backgroundColor:'#ff9b8a' }
      ]},
      options:{
        plugins:{tooltip:{callbacks:{label:ctx=> ctx.dataset.label+': '+fmt(ctx.raw,0)}}},
        responsive:true, maintainAspectRatio:false, scales:{x:{stacked:true}, y:{stacked:true}}
      }
    });

    document.getElementById('chart-status').onclick = function(evt){
      const points = chartStatus.getElementsAtEventForMode(evt,'nearest',{intersect:true},true);
      if(points.length){
        const idx = points[0].index;
        openDrillModal(items[idx]);
      }
    };
  }

  // render detail table (with toggle hide empty)
  function renderDetailTable(allData, hideEmpty){
    const tbody = $('#detail-body');
    tbody.innerHTML = '';
    // rows: each raw row from reg or ibm, but standardize columns
    const sources = [];
    allData.forEach(r=> {
      if(r.Sektor) sources.push({jenis:'Reguler', key:r.Sektor, row:r});
      if(r.Program) sources.push({jenis:'IBM', key:r.Program, row:r});
    });

    // build one table row per source-row
    sources.forEach(s=>{
      const r = s.row;
      // hide if hideEmpty and all technical fields empty
      const techFields = ['Kapasitas Terpasang','Kapasitas Terpakai','Idle Capacity','Luas Penanganan','Luas Kawasan'];
      const allEmpty = techFields.every(f=>{
        const v = r[f];
        return v===undefined || v==='' || v==='-' || v===0 || v==='0';
      });
      if(hideEmpty && allEmpty) return;

      const tr = el('tr');
      tr.style.borderBottom = '1px solid rgba(255,255,255,0.04)';
      tr.style.color = '#fff';
      tr.innerHTML = `<td style="padding:8px">${s.jenis}</td>
        <td style="padding:8px">${capv(r.Sektor||r.Program)}</td>
        <td style="padding:8px">${r['Kapasitas Terpasang']? (r['Kapasitas Terpasang'] + (r['Satuan Kapasitas']? ' '+r['Satuan Kapasitas']:'')) : 'N/A'}</td>
        <td style="padding:8px">${r['Kapasitas Terpakai']? (r['Kapasitas Terpakai'] + (r['Satuan Kapasitas']? ' '+r['Satuan Kapasitas']:'')) : 'N/A'}</td>
        <td style="padding:8px">${r['Idle Capacity']? (r['Idle Capacity'] + (r['Satuan Kapasitas']? ' '+r['Satuan Kapasitas']:'')) : 'N/A'}</td>
        <td style="padding:8px">${r['Luas Penanganan']? r['Luas Penanganan'] : 'N/A'}</td>
        <td style="padding:8px">${r['Luas Kawasan']? r['Luas Kawasan'] : 'N/A'}</td>`;
      tbody.appendChild(tr);
    });
  }

  // drill modal
  function openDrillModal(item){
    $('#modal-title').textContent = item.label || item.Sektor || item.Program || 'Detail';
    const body = $('#modal-body');
    body.innerHTML = '';
    // if item has rows, show list
    if(item.rows && item.rows.length){
      const list = el('div');
      item.rows.forEach(r=>{
        const card = el('div');
        card.style.padding='8px';
        card.style.borderBottom='1px solid rgba(255,255,255,0.04)';
        card.innerHTML = `<div style="font-weight:700">${r.NamaUnit || (r.UnitName || r.ID || 'Unit')}</div>
          <div style="color:var(--muted);font-size:13px">Lokasi: ${r.Lokasi || r.Kecamatan || 'N/A'}</div>
          <div style="margin-top:6px;font-size:13px">Status: Berfungsi ${fmt(r.Berfungsi,0)} | Tidak ${fmt(r['Tidak Berfungsi'],0)}</div>`;
        list.appendChild(card);
      });
      body.appendChild(list);
    } else {
      body.innerHTML = '<div style="color:var(--muted)">Detail unit tidak tersedia pada sumber data. Jika tersedia, field "rows" akan ditampilkan di modal.</div>';
    }
    $('#modal-drill').style.display = 'flex';
  }

  // UI bindings
  $('#modal-close').addEventListener('click', ()=> $('#modal-drill').style.display='none');
  $('#toggle-hide-empty').addEventListener('change', ()=> {
    const hide = $('#toggle-hide-empty').checked;
    renderDetailTable(dataReg.concat(dataIbm), hide);
  });

  function capv(v){ return v===undefined||v===''? 'N/A' : v; }

  // Load data + init UI
  Promise.all([fetch(PATH_REG).then(r=>r.json()), fetch(PATH_IBM).then(r=>r.json())])
    .then(([reg, ibm])=>{
      dataReg = reg; dataIbm = ibm;
      // collect possible years from data if present (field 'Tahun' or 'Tahun Anggaran')
      const years = new Set();
      [...dataReg, ...dataIbm].forEach(r=>{
        if(r.Tahun) years.add(String(r.Tahun));
        if(r['Tahun Anggaran']) years.add(String(r['Tahun Anggaran']));
      });
      const yearSel = $('#filter-year');
      yearSel.innerHTML = '<option value="all">Semua</option>';
      Array.from(years).sort().forEach(y=>{
        const opt = el('option'); opt.value= y; opt.textContent = y; yearSel.appendChild(opt);
      });

      // initial render with Gabungan, all years
      const combined = dataReg.concat(dataIbm);
      buildKPI(combined);

      const aggIbm = aggregateForCharts(dataIbm,'ibm');
      const aggReg = aggregateForCharts(dataReg,'reguler');

      // default charts: use IBM programs first (per request)
      const chartItems = aggIbm.length ? aggIbm : aggReg;
      buildInvestChart(chartItems);
      buildStatusChart(chartItems);

      renderDetailTable(combined, $('#toggle-hide-empty').checked);

      // filter handlers
      $('#filter-source').addEventListener('change', (e)=>{
        const val = e.target.value;
        let items = [];
        if(val==='ibm'){ items = aggIbm; buildInvestChart(aggIbm); buildStatusChart(aggIbm); }
        else if(val==='reguler'){ items = aggReg; buildInvestChart(aggReg); buildStatusChart(aggReg); }
        else { const merged = aggReg.concat(aggIbm); buildInvestChart(merged); buildStatusChart(merged); }
      });

      $('#filter-year').addEventListener('change', (e)=>{
        const y = e.target.value;
        // filter data arrays by year if year present; otherwise no-op
        const pick = arr => arr.filter(r=> {
          if(y==='all') return true;
          return String(r.Tahun || r['Tahun Anggaran'] || '') === y;
        });
        const regF = pick(dataReg), ibmF= pick(dataIbm);
        buildKPI(regF.concat(ibmF));
        const aggI = aggregateForCharts(ibmF,'ibm'), aggR = aggregateForCharts(regF,'reguler');
        const source = $('#filter-source').value;
        if(source==='ibm'){ buildInvestChart(aggI); buildStatusChart(aggI); }
        else if(source==='reguler'){ buildInvestChart(aggR); buildStatusChart(aggR); }
        else { buildInvestChart(aggR.concat(aggI)); buildStatusChart(aggR.concat(aggI)); }
        renderDetailTable(regF.concat(ibmF), $('#toggle-hide-empty').checked);
      });

    })
    .catch(err=>{
      console.error(err);
      grid.innerHTML = '<div style="color:#ffb4b4">Gagal memuat data. Periksa file JSON pada folder /data/</div>';
    });

})();
</script>
<!-- END: Dashboard Interaktif Rekap -->

 
  <!-- ===== Footer ===== -->
  <footer>
    &copy; 2025 MalukuInfraZone - BPBPK Maluku. Semua Hak Dilindungi.
    <span class="tagline">Transparansi Data, Akselerasi Pembangunan Negeri.</span>
  </footer>

  <!-- ===== Script Header Scroll ===== -->
  <script>
    const header = document.getElementById('site-header');
    function checkHeader() {
      if (!header) return;
      if (window.scrollY > 50) {
        header.classList.add('scrolled');
      } else {
        header.classList.remove('scrolled');
      }
    }
    window.addEventListener('load', checkHeader);
    window.addEventListener('scroll', checkHeader, { passive: true });
  </script>
  
</body>
</html>
