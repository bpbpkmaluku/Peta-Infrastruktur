<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>MalukuInfraZone</title>
  <meta name="description" content="Portal data dan peta infrastruktur BPBPK Maluku">
  <link rel="icon" type="image/png" href="images/logo-pu.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@400;500;600;700;900&family=Montserrat:wght@400;600;700;900&family=Poppins:wght@300;400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg-dark:#0b0f17;--accent:#3b82f6;--accent-2:#f59e0b;--muted:#a7b6c8;
      --font-poppins:'Poppins',sans-serif;--font-montserrat:'Montserrat',sans-serif;--font-raleway:'Raleway',sans-serif;
    }
    html,body{height:100%;margin:0;font-family:var(--font-poppins);background:var(--bg-dark);color:#fff;padding-top:72px;overflow-x:hidden}
    header{display:flex;align-items:center;justify-content:space-between;padding:18px 36px;position:fixed;top:0;left:0;right:0;z-index:50;background:rgba(11,15,23,0.75);backdrop-filter:blur(8px)}
    .brand{display:flex;align-items:center;gap:20px}.brand img{height:44px}.site-title{font-family:var(--font-raleway);font-weight:800;font-size:28px}
    .nav a{margin-left:22px;color:#fff;text-decoration:none;font-weight:600}.nav a:hover{color:var(--accent)}
    .hero{height:60vh;display:flex;align-items:center;justify-content:center;text-align:center;flex-direction:column;position:relative;background:url('images/background-maluku.jpg') no-repeat center/cover}
    .hero::after{content:'';position:absolute;inset:0;background:linear-gradient(180deg,rgba(0,0,0,0.6),rgba(0,0,0,0.7))}
    .hero-content{position:relative;z-index:10;max-width:880px;padding:20px}
    .hero h1{font-size:44px;font-family:var(--font-montserrat);font-weight:900;margin:0}
    .hero p{margin-top:12px;color:var(--muted);font-size:16px}
    .btn-primary{margin-top:18px;padding:12px 22px;border-radius:999px;font-weight:700;background:var(--accent);color:#021129;text-decoration:none}
    .sectors{padding:40px 20px;max-width:1160px;margin:0 auto;text-align:center}
    .sectors h2{font-size:28px;font-family:var(--font-montserrat);font-weight:800;margin-bottom:24px}
    /* dashboard area */
    #dash-wrap{max-width:1160px;margin:20px auto 60px;padding:18px;border-radius:12px}
    .controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:12px}
    .kpi-row{display:flex;gap:12px;align-items:center;flex-wrap:wrap;justify-content:space-between;margin-bottom:12px}
    .kpi-card{background:#0b1220;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03)}
    #charts{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:12px}
    #detail-box{background:#0f1620;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04)}
    table{width:100%;border-collapse:collapse;font-size:13px}
    thead th{color:var(--muted);text-align:left;padding:8px;border-bottom:1px solid rgba(255,255,255,0.04)}
    tbody td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.03)}
    /* card grid for visual renderer */
    #rekapGrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:18px}
    .card{background:#0f1620;border-radius:12px;padding:14px;border:1px solid rgba(255,255,255,0.04);box-shadow:0 8px 24px rgba(0,0,0,0.45)}
    /* modal */
    #modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:9999}
    #modal .box{width:880px;max-width:95%;background:#08101a;padding:18px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);color:#fff}
    @media(max-width:820px){#charts{grid-template-columns:1fr} .hero{height:50vh}}
  </style>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <header id="site-header">
    <div class="brand">
      <img src="images/favicon.png" alt="Logo MalukuInfraZone">
      <div class="site-title">MalukuInfraZone</div>
    </div>
    <nav class="nav">
      <a href="index.html">Beranda</a>
      <a href="peta.html">Peta Infrastruktur</a>
    </nav>
  </header>

  <section class="hero">
    <div class="hero-content">
      <h1>Platform Digital BPBPK Maluku</h1>
      <p>Transparansi Data â€” Akses Informasi Infrastruktur Terbangun Balai Penataan Bangunan, Prasarana dan Kawasan Maluku</p>
      <a href="peta.html" class="btn-primary">Lihat Peta Infrastruktur</a>
    </div>
  </section>

  <section class="sectors">
    <h2>Sektor-Sektor di BPBPK Maluku</h2>
    <div class="sector-list">
      <div class="sector-card">
        <img class="icon" src="images/icon-air.png" alt="Icon Air Minum">
        <h3>Air Minum</h3>
        <p>Menyediakan infrastruktur air minum yang layak untuk masyarakat Maluku.</p>
      </div>
      <div class="sector-card">
        <img class="icon" src="images/icon-sanitasi.png" alt="Icon Sanitasi">
        <h3>Sanitasi</h3>
        <p>Pembangunan dan pengelolaan infrastruktur sanitasi yang mendukung kesehatan lingkungan.</p>
      </div>
      <div class="sector-card">
        <img class="icon" src="images/icon-bina.png" alt="Icon Bina Penataan Bangunan">
        <h3>Bina Penataan Bangunan</h3>
        <p>Pengelolaan tata bangunan dan pengawasan kualitas pembangunan gedung.</p>
      </div>
      <div class="sector-card">
        <img class="icon" src="images/icon-kawasan.png" alt="Icon Pengembangan Kawasan Strategis">
        <h3>Pengembangan Kawasan Strategis</h3>
        <p>Pengembangan kawasan strategis untuk mendukung pertumbuhan wilayah Maluku.</p>
      </div>
    </div>
  </section>

  <!-- DASHBOARD -->
  <div id="dash-wrap" style="max-width:1160px;margin:20px auto;">
    <div class="kpi-row">
      <div>
        <h2 style="font-family:var(--font-montserrat);margin:0 0 6px">Rekapitulasi Status Keberfungsian Infrastruktur Terbangun<br>Tahun Anggaran 2020 - 2024</h2>
        <div style="color:var(--muted);font-size:13px;margin-bottom:8px">Sumber: Balai Penataan Bangunan, Prasarana dan Kawasan Permukiman Wilayah Maluku</div>
      </div>
      <div style="display:flex;gap:10px;align-items:center">
        <div class="kpi-card"><div style="font-size:12px;color:var(--muted)">Total Investasi</div><div id="kpi-invest" style="font-weight:800;color:#ffd54f">-</div></div>
        <div class="kpi-card"><div style="font-size:12px;color:var(--muted)">Total Unit Terbangun</div><div id="kpi-units" style="font-weight:800">-</div></div>
        <div class="kpi-card" style="text-align:center">
          <div style="font-size:12px;color:var(--muted)">Keberfungsian</div>
          <canvas id="kpi-donut" width="100" height="70"></canvas>
          <div id="kpi-donut-label" style="font-weight:800;color:#88e28f;margin-top:6px">-</div>
        </div>
      </div>
    </div>

    <div class="controls">
      <label style="color:var(--muted)">Tahun:</label>
      <select id="filter-year" style="padding:6px;border-radius:6px;background:transparent;color:#fff;border:1px solid rgba(255,255,255,0.06)"><option value="all">Semua</option></select>

      <label style="color:var(--muted)">Sumber:</label>
      <select id="filter-source" style="padding:6px;border-radius:6px;background:transparent;color:#fff;border:1px solid rgba(255,255,255,0.06)">
        <option value="gabungan">Gabungan</option>
        <option value="reguler">Reguler</option>
        <option value="ibm">IBM</option>
      </select>

      <label style="color:var(--muted);margin-left:auto"><input id="toggle-hide-empty" type="checkbox" checked style="margin-right:6px">Sembunyikan Baris Data Kosong</label>
    </div>

    <div id="charts">
      <div id="chart-invest-wrap" style="background:#0f1620;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04)">
        <div style="color:var(--muted);margin-bottom:8px">Nilai Investasi per Program</div>
        <canvas id="chart-invest" height="240"></canvas>
      </div>
      <div id="chart-status-wrap" style="background:#0f1620;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04)">
        <div style="color:var(--muted);margin-bottom:8px">Status Keberfungsian</div>
        <canvas id="chart-status" height="240"></canvas>
      </div>
    </div>

    <div id="detail-box">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div style="color:var(--muted)">Tabel Detail Teknis</div>
        <div style="color:var(--muted);font-size:13px">Satuan tertampil pada kolom</div>
      </div>
      <div style="overflow:auto">
        <table id="detail-table">
          <thead>
            <tr>
              <th>Jenis</th><th>Program/Sektor</th><th>Kapasitas Terpasang</th><th>Kapasitas Terpakai</th><th>Idle Capacity</th><th>Luas Penanganan</th><th>Luas Kawasan</th>
            </tr>
          </thead>
          <tbody id="detail-body"></tbody>
        </table>
      </div>
    </div>

    <div style="margin-top:18px">
      <div id="rekapGrid"></div>
    </div>
  </div>

  <!-- Modal -->
  <div id="modal"><div class="box">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
      <div id="modal-title" style="font-weight:800;color:#ffd54f">Detail</div>
      <button id="modal-close" style="background:transparent;border:0;color:var(--muted);font-weight:700;cursor:pointer">Tutup</button>
    </div>
    <div id="modal-body" style="max-height:60vh;overflow:auto;font-size:13px"></div>
  </div></div>

  <footer style="margin-top:24px;text-align:center;padding:40px;color:var(--muted);background:#0b0f17">
    &copy; 2025 MalukuInfraZone - BPBPK Maluku. Semua Hak Dilindungi.
    <span class="tagline" style="display:block;margin-top:8px;font-size:16px;color:#fff;font-weight:600">Transparansi Data, Akselerasi Pembangunan Negeri.</span>
  </footer>

<script>
(function(){
  const PATH_REG = 'data/rekap_reguler.json';
  const PATH_IBM = 'data/rekap_ibm.json';
  let dataReg=[], dataIbm=[];
  const grid = document.getElementById('rekapGrid');

  // chart instances
  let chartInvest=null, chartStatus=null, donutChart=null;

  // helpers
  const $ = s => document.querySelector(s);
  const el = t => document.createElement(t);
  const fmt = (n,d=2) => {
    if(n===undefined||n===null||n==='-'||n==='') return 'N/A';
    const num = Number(String(n).replace(/[^0-9.-]/g,''));
    if(isNaN(num)) return n;
    return num.toLocaleString('id-ID',{minimumFractionDigits:0,maximumFractionDigits:d});
  };

  // aggregate for charts
  function aggregate(items, keyField){
    const map = {};
    items.forEach(r=>{
      const key = keyField==='Program' ? (r.Program||'Unknown') : (r.Sektor||'Unknown');
      if(!map[key]) map[key]={label:key, invest:0, unit:0, berfungsi:0, tidak:0, rows:[]};
      map[key].invest += Number(r['Nilai Investasi (Miliar)']||0);
      map[key].unit += Number(r['Jumlah Unit']||0);
      map[key].berfungsi += Number(r['Berfungsi']||0);
      map[key].tidak += Number(r['Tidak Berfungsi']||0);
      map[key].rows.push(r);
    });
    return Object.values(map);
  }

  // KPI build
  function buildKPI(all){
    const totInvest = all.reduce((s,i)=>s+Number(i['Nilai Investasi (Miliar)']||0),0);
    const totUnits = all.reduce((s,i)=>s+Number(i['Jumlah Unit']||0),0);
    const totBerfungsi = all.reduce((s,i)=>s+Number(i['Berfungsi']||0),0);
    const totTidak = all.reduce((s,i)=>s+Number(i['Tidak Berfungsi']||0),0);
    $('#kpi-invest').textContent = totInvest?('Rp '+fmt(totInvest,2)+' M'):'N/A';
    $('#kpi-units').textContent = totUnits?fmt(totUnits,0):'N/A';
    const pct = totUnits?Math.round((totBerfungsi/totUnits)*100):0;
    $('#kpi-donut-label').textContent = pct? (pct+'%') : 'N/A';
    const ctx = $('#kpi-donut').getContext('2d');
    if(donutChart) donutChart.destroy();
    donutChart = new Chart(ctx, {
      type:'doughnut',
      data:{labels:['Berfungsi','Tidak'],datasets:[{data:[totBerfungsi,totTidak],backgroundColor:['#88e28f','#ff9b8a']}]},
      options:{cutout:'70%',plugins:{tooltip:{callbacks:{label(c){return c.label+': '+fmt(c.raw,0)}}}},maintainAspectRatio:true}
    });
  }

  // invest chart
  function buildInvestChart(items){
    const labels = items.map(i=>i.label);
    const data = items.map(i=>Number(i.invest||0));
    const ctx = $('#chart-invest').getContext('2d');
    if(chartInvest) chartInvest.destroy();
    chartInvest = new Chart(ctx,{type:'bar',data:{labels,datasets:[{label:'Nilai Investasi (Miliar)',data,backgroundColor:'#3b82f6'}]},options:{
      indexAxis:'y',plugins:{legend:{display:false},tooltip:{callbacks:{label(ctx){return 'Rp '+fmt(ctx.raw,2)+' M | '+items[ctx.dataIndex].unit+' unit'}}}},responsive:true,maintainAspectRatio:false,
      scales:{x:{ticks:{callback:val=>'Rp '+fmt(val,2)+' M'}}}
    });
    $('#chart-invest').onclick = (evt)=>{ const pts = chartInvest.getElementsAtEventForMode(evt,'nearest',{intersect:true},true); if(pts.length){ const idx=pts[0].index; openDrillModal(items[idx]); }};
  }

  // status chart
  function buildStatusChart(items){
    const labels = items.map(i=>i.label);
    const dataBer = items.map(i=>Number(i.berfungsi||0));
    const dataTidak = items.map(i=>Number(i.tidak||0));
    const ctx = $('#chart-status').getContext('2d');
    if(chartStatus) chartStatus.destroy();
    chartStatus = new Chart(ctx,{type:'bar',data:{labels,datasets:[
      {label:'Berfungsi',data:dataBer,backgroundColor:'#88e28f'},{label:'Tidak Berfungsi',data:dataTidak,backgroundColor:'#ff9b8a'}
    ]},options:{plugins:{tooltip:{callbacks:{label(c){return c.dataset.label+': '+fmt(c.raw,0)}}}},responsive:true,maintainAspectRatio:false,scales:{x:{stacked:true},y:{stacked:true}}});
    $('#chart-status').onclick = (evt)=>{ const pts = chartStatus.getElementsAtEventForMode(evt,'nearest',{intersect:true},true); if(pts.length){ const idx=pts[0].index; openDrillModal(items[idx]); }};
  }

  // detail table
  function renderDetailTable(all, hideEmpty){
    const tbody = $('#detail-body'); tbody.innerHTML='';
    const rows = [];
    all.forEach(r=>{
      const jenis = r.Program? 'IBM' : (r.Sektor? 'Reguler' : 'Lain');
      rows.push({jenis,key:(r.Program||r.Sektor||''),row:r});
    });
    rows.forEach(s=>{
      const r=s.row;
      const tech = ['Kapasitas Terpasang','Kapasitas Terpakai','Idle Capacity','Luas Penanganan','Luas Kawasan'];
      const allEmpty = tech.every(f=> r[f]===undefined || r[f]==='' || r[f]==='-' || r[f]===0 || r[f]==='0');
      if(hideEmpty && allEmpty) return;
      const tr = el('tr');
      tr.innerHTML = `<td>${s.jenis}</td>
        <td>${(r.Sektor||r.Program||'N/A')}</td>
        <td>${r['Kapasitas Terpasang']? r['Kapasitas Terpasang'] + (r['Satuan Kapasitas']? ' '+r['Satuan Kapasitas'] : '') : 'N/A'}</td>
        <td>${r['Kapasitas Terpakai']? r['Kapasitas Terpakai'] + (r['Satuan Kapasitas']? ' '+r['Satuan Kapasitas'] : '') : 'N/A'}</td>
        <td>${r['Idle Capacity']? r['Idle Capacity'] + (r['Satuan Kapasitas']? ' '+r['Satuan Kapasitas'] : '') : 'N/A'}</td>
        <td>${r['Luas Penanganan']? r['Luas Penanganan'] : 'N/A'}</td>
        <td>${r['Luas Kawasan']? r['Luas Kawasan'] : 'N/A'}</td>`;
      tbody.appendChild(tr);
    });
  }

  // visual card renderer
  function makeCard(title, meta, typeKey){
    const c = el('div'); c.className='card';
    const hdr = el('div'); hdr.style.display='flex'; hdr.style.justifyContent='space-between'; hdr.style.alignItems='center';
    const t = el('div'); t.textContent = title; t.style.color = (typeKey==='ibm' ? '#fcd34d' : '#3b82f6'); t.style.fontWeight=800;
    const badge = el('div'); badge.textContent='Data s.d. 2024'; badge.style.background = typeKey==='ibm' ? '#fcd34d' : '#3b82f6'; badge.style.color='#021129'; badge.style.padding='4px 8px'; badge.style.borderRadius='6px'; badge.style.fontWeight=700; badge.style.fontSize='12px';
    hdr.appendChild(t); hdr.appendChild(badge); c.appendChild(hdr);

    const top = el('div'); top.style.display='flex'; top.style.justifyContent='space-between'; top.style.alignItems='center'; top.style.margin='8px 0';
    top.innerHTML = `<div style="color:var(--muted);font-size:12px">Nilai Investasi</div><div style="font-weight:800;color:#ffd54f">${meta.invest?('Rp '+Number(meta.invest).toLocaleString('id-ID')+' M'):'N/A'}</div>`;
    const units = el('div'); units.innerHTML = `<div style="color:var(--muted);font-size:12px">Unit</div><div style="font-weight:800">${meta.unit?Number(meta.unit).toLocaleString('id-ID'):'N/A'}</div>`;
    top.appendChild(units); c.appendChild(top);

    const row = el('div'); row.style.display='flex'; row.style.gap='12px'; row.style.alignItems='center';
    const progWrap = el('div'); progWrap.style.flex='1';
    const pct = meta.unit? Math.round((meta.berfungsi/meta.unit||0)*100):0;
    const lbl = el('div'); lbl.style.color='var(--muted)'; lbl.style.fontSize='12px'; lbl.textContent='Keberfungsian';
    const barBg = el('div'); barBg.style.height='10px'; barBg.style.background='rgba(255,255,255,0.04)'; barBg.style.borderRadius='6px'; barBg.style.marginTop='6px';
    const bar = el('div'); bar.style.width=pct+'%'; bar.style.height='100%'; bar.style.background = pct>80? '#88e28f' : (pct>40? '#f59e0b' : '#ff7b7b'); bar.style.borderRadius='6px';
    barBg.appendChild(bar); progWrap.appendChild(lbl); progWrap.appendChild(barBg); row.appendChild(progWrap);

    const canWrap = el('div'); canWrap.style.width='80px'; canWrap.style.height='80px';
    const canvas = el('canvas'); canvas.width=80; canvas.height=80; canWrap.appendChild(canvas); row.appendChild(canWrap);
    c.appendChild(row);

    const foot = el('div'); foot.style.display='flex'; foot.style.justifyContent='space-between'; foot.style.alignItems='center'; foot.style.marginTop='8px';
    foot.innerHTML = `<div style="color:var(--muted);font-size:12px">Berfungsi: ${meta.berfungsi||0} | Tidak: ${meta.tidak||0}</div>`;
    const btn = el('button'); btn.textContent='Detail'; btn.style.background='transparent'; btn.style.border='1px solid rgba(255,255,255,0.06)'; btn.style.color='var(--muted)'; btn.style.padding='6px 10px'; btn.style.borderRadius='8px'; btn.style.cursor='pointer';
    btn.addEventListener('click',()=>openDrillModal(meta));
    foot.appendChild(btn); c.appendChild(foot);

    if(window.Chart){
      new Chart(canvas.getContext('2d'),{type:'doughnut',data:{labels:['Berfungsi','Tidak'],datasets:[{data:[meta.berfungsi||0,meta.tidak||0],backgroundColor:['#88e28f','#ff9b8a']}]},options:{plugins:{legend:{display:false}},cutout:'70%',maintainAspectRatio:true}});
    }
    return c;
  }

  function renderCardsVisual(data, keyField, typeKey){
    grid.innerHTML=''; const items = aggregate(data,keyField);
    const nonEmpty = items.filter(it=>!(it.unit===0 && it.invest===0 && it.berfungsi===0 && it.tidak===0));
    if(nonEmpty.length===0){ grid.innerHTML='<div style="color:var(--muted);text-align:center;padding:20px">Tidak ada data aktif.</div>'; return; }
    nonEmpty.forEach(it=> grid.appendChild(makeCard(it.label, it, typeKey||keyField==='Program'?'ibm':'reguler')));
  }

  // modal functions
  function openDrillModal(item){
    $('#modal-title').textContent = item.label || 'Detail';
    const body = $('#modal-body'); body.innerHTML = '';
    if(item.rows && item.rows.length){
      item.rows.forEach(r=>{
        const block = el('div'); block.style.padding='8px'; block.style.borderBottom='1px solid rgba(255,255,255,0.04)';
        block.innerHTML = `<div style="font-weight:700">${r.NamaUnit||r.Unit||r.ID||'Unit'}</div>
          <div style="color:var(--muted);font-size:13px">Lokasi: ${r.Lokasi || r.Kecamatan || 'N/A'}</div>
          <div style="margin-top:6px;font-size:13px">Status: Berfungsi ${r.Berfungsi||0} | Tidak ${r['Tidak Berfungsi']||0}</div>`;
        body.appendChild(block);
      });
    } else {
      body.innerHTML = '<div style="color:var(--muted)">Detail unit tidak tersedia di data. Untuk detail unit, tambahkan field NamaUnit/Lokasi pada JSON.</div>';
    }
    $('#modal').style.display='flex';
  }
  $('#modal-close').addEventListener('click',()=>$('#modal').style.display='none');

  // load and initialize
  Promise.all([fetch(PATH_REG).then(r=>r.json()), fetch(PATH_IBM).then(r=>r.json())])
  .then(([reg,ibm])=>{
    dataReg=reg; dataIbm=ibm;
    // build year list if present
    const years = new Set();
    [...dataReg,...dataIbm].forEach(r=>{ if(r.Tahun) years.add(String(r.Tahun)); if(r['Tahun Anggaran']) years.add(String(r['Tahun Anggaran'])); });
    const yearSel = $('#filter-year'); years.size && Array.from(years).sort().forEach(y=>{ const o = el('option'); o.value=y; o.textContent=y; yearSel.appendChild(o); });

    const combined = dataReg.concat(dataIbm);
    buildKPI(combined);

    // charts initial: prefer IBM if present
    const aggIbm = aggregate(dataIbm,'Program'), aggReg = aggregate(dataReg,'Sektor');
    const chartSource = aggIbm.length? aggIbm : aggReg;
    buildInvestChart(chartSource); buildStatusChart(chartSource);

    renderDetailTable(combined, $('#toggle-hide-empty').checked);
    renderCardsVisual(combined, 'Sektor');

    // UI handlers
    $('#filter-source').addEventListener('change', (e)=>{
      const v=e.target.value;
      if(v==='ibm'){ buildInvestChart(aggIbm); buildStatusChart(aggIbm); renderCardsVisual(dataIbm,'Program','ibm'); }
      else if(v==='reguler'){ buildInvestChart(aggReg); buildStatusChart(aggReg); renderCardsVisual(dataReg,'Sektor','reguler'); }
      else { const merged = aggReg.concat(aggIbm); buildInvestChart(merged); buildStatusChart(merged); renderCardsVisual(combined,'Sektor'); }
    });

    $('#filter-year').addEventListener('change',(e)=>{
      const y = e.target.value;
      const pick = arr => arr.filter(r=> { if(y==='all') return true; return String(r.Tahun||r['Tahun Anggaran']||'')===y; });
      const regF = pick(dataReg), ibmF = pick(dataIbm);
      buildKPI(regF.concat(ibmF));
      const aI = aggregate(ibmF,'Program'), aR = aggregate(regF,'Sektor');
      const src = $('#filter-source').value;
      if(src==='ibm'){ buildInvestChart(aI); buildStatusChart(aI); renderCardsVisual(ibmF,'Program','ibm'); }
      else if(src==='reguler'){ buildInvestChart(aR); buildStatusChart(aR); renderCardsVisual(regF,'Sektor','reguler'); }
      else { buildInvestChart(aR.concat(aI)); buildStatusChart(aR.concat(aI)); renderCardsVisual(regF.concat(ibmF),'Sektor'); }
      renderDetailTable(regF.concat(ibmF), $('#toggle-hide-empty').checked);
    });

    $('#toggle-hide-empty').addEventListener('change', ()=> renderDetailTable(dataReg.concat(dataIbm), $('#toggle-hide-empty').checked));

  })
  .catch(err=>{
    console.error(err);
    document.getElementById('dash-wrap').innerHTML = '<div style="color:#ffb4b4;padding:20px">Gagal memuat data. Periksa file JSON pada /data/</div>';
  });

})();
</script>

<script>
  // header scroll effect
  const header = document.getElementById('site-header');
  function checkHeader(){ if(!header) return; if(window.scrollY>50) header.classList.add('scrolled'); else header.classList.remove('scrolled'); }
  window.addEventListener('load', checkHeader); window.addEventListener('scroll', checkHeader, {passive:true});
</script>

</body>
</html>
