<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MalukuInfraZone - Complete</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;900&family=Poppins:wght@300;400;600;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" href="data:," />
  <style>
    :root{ --font-poppins: 'Poppins', sans-serif; --font-montserrat: 'Montserrat', sans-serif; }
    body{ font-family:var(--font-poppins); background: linear-gradient(135deg,#111111,#1f1f2e,#2b2b2b,#000000); background-attachment: fixed; overflow-x:hidden; color: #fff; }
    .font-poppins{ font-family:var(--font-poppins); }
    .font-montserrat{ font-family:var(--font-montserrat); }
    #map { width:100%; height:70vh; min-height:500px; border-radius:12px; overflow:hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
    .filter-section { position: fixed; bottom: 120px; right: 20px; background: rgba(31, 41, 55, 0.95); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.15); border-radius: 12px; padding: 16px; max-width: 280px; box-shadow: 0 10px 30px rgba(0,0,0,0.4); z-index: 1000; }

    /* Ensure filter controls are legible on dark background */
    .filter-section label { color: #cbd5e1; }
    .filter-section select, .filter-section input, .filter-section button {
      background: rgba(255,255,255,0.04);
      color: #e5e7eb; /* light text */
      border: 1px solid rgba(255,255,255,0.06);
    }
    .filter-section option { background: #0b1220; color: #e5e7eb; }
    .filter-section select { -webkit-appearance: none; appearance: none; }

    .error-message { background: rgba(220, 38, 38, 0.1); border: 1px solid rgba(220, 38, 38, 0.3); border-radius: 8px; padding: 12px; margin: 10px 0; color: #fca5a5; font-size: 14px; text-align: center; }
    .loading { position: absolute; left:50%; top:50%; transform:translate(-50%,-50%); background: rgba(0,0,0,0.6); padding:10px 16px; border-radius:8px; display:none; z-index:1200; }

    /* Force InfoWindow content dark text on light background so content is readable */
    .gm-style .gm-style-iw { background: #ffffff !important; color: #111 !important; }
    .gm-style .gm-style-iw * { color: #111 !important; }

  </style>
</head>
<body class="text-white relative min-h-screen font-poppins">
  <header class="flex justify-between items-center px-6 py-4 relative z-10 bg-black bg-opacity-20 backdrop-blur-sm">
    <div class="flex items-center space-x-3">
      <img src="https://cdn-icons-png.flaticon.com/512/854/854878.png" alt="Map Icon" class="w-8 h-8">
      <h1 class="text-2xl font-extrabold">Maluku<span class="text-yellow-500">InfraZone</span></h1>
    </div>
    <div class="font-montserrat font-bold text-blue-300 uppercase tracking-wider">BPBPK Maluku</div>
  </header>

  <section class="hero-section flex flex-col items-center text-center px-6 relative z-10">
    <h2 class="text-4xl md:text-5xl font-extrabold leading-tight">Layanan Balai <span class="text-yellow-500">Terpadu</span></h2>
    <p class="text-gray-300 max-w-2xl mt-4 font-light">Platform digital untuk mempermudah akses informasi dan layanan infrastruktur.</p>
    <div class="mt-8"><a href="#peta" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold px-8 py-3 rounded-full shadow-lg">Peta Infrastruktur</a></div>
  </section>

  <section id="peta" class="mt-12 px-6 relative z-10 pb-20">
    <h3 class="text-2xl md:text-3xl font-bold mb-6 text-center">Peta Infrastruktur</h3>
    <div id="map"></div>
    <div id="errorMessage" class="error-message" style="display:none"></div>
    <div id="loading" class="loading">Memuat data...</div>
  </section>

  <div class="filter-section" id="filterSection">
    <h4 class="text-center text-blue-300 font-semibold mb-3">Filter Data</h4>
    <div class="filter-group mb-2">
      <label for="sectorFilter" class="text-sm text-gray-300 mb-1">Sektor:</label>
      <select id="sectorFilter" class="w-full p-2 bg-transparent border rounded text-white"></select>
    </div>
    <div class="filter-group mb-2">
      <label for="yearFilter" class="text-sm text-gray-300 mb-1">Tahun:</label>
      <select id="yearFilter" class="w-full p-2 bg-transparent border rounded text-white"></select>
    </div>
    <div class="flex gap-2">
      <button class="px-3 py-2 bg-blue-600 rounded font-semibold" id="applyBtn">Terapkan</button>
      <button class="px-3 py-2 bg-gray-600 rounded font-semibold" id="resetBtn">Reset</button>
    </div>
    <div id="filterInfo" class="text-xs text-gray-400 mt-2"></div>
  </div>

  <footer class="fixed bottom-4 right-4 z-10"><img src="https://cdn-icons-png.flaticon.com/512/921/921490.png" alt="Engineer Icon" class="w-12 h-12 opacity-80"></footer>

  <!-- MarkerClusterer script from Google Maps utilities -->
  <script src="https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/markerclusterer.js"></script>

  <!-- Google Maps API. Replace YOUR_API_KEY with a restricted key. Keep async and defer. -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBEZqcze-RGCcRGIBjyEt0-ID99TCDJeS0&callback=initMap" async defer></script>

  <script>
    // Minimal escape
    function escapeHtml(s){ return String(s||'').replace(/[&<>\"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    let map;
    let infoWindow;
    let allMarkers = []; // { marker, props }
    let markerCluster = null;
    let geoData = null;
    const uniqueSectors = new Set();
    const uniqueYears = new Set();
    const currentFilter = { sector: '', year: '' };

    function showError(msg){
      const d = document.getElementById('errorMessage');
      d.textContent = msg; d.style.display = 'block';
      console.error(msg);
    }
    function hideError(){ document.getElementById('errorMessage').style.display = 'none'; }
    function showLoading(){ document.getElementById('loading').style.display = 'block'; }
    function hideLoading(){ document.getElementById('loading').style.display = 'none'; }

    // Build info HTML
    function buildInfoHtml(props){
      if(!props || Object.keys(props).length === 0) return '(tidak ada atribut)';
      const title = props.Nama_Infrastruktur || props.nama || props.Name || props.name || props['Nama Infrastruktur'] || '';
      const lines = ['<div style="max-width:300px;font-size:13px">'];
      if(title) lines.push('<b>' + escapeHtml(title) + '</b>');
      if(props.Sektor) lines.push('Sektor: ' + escapeHtml(props.Sektor));
      if(props.Tahun_Pembangunan) lines.push('Tahun: ' + escapeHtml(props.Tahun_Pembangunan));
      if(props.Status_Keberfungsian) lines.push('Status: ' + escapeHtml(props.Status_Keberfungsian));
      if(props.Keterangan) lines.push('<div style="margin-top:6px">' + escapeHtml(props.Keterangan) + '</div>');
      // fallback list minimal
      if(!title){
        Object.keys(props).slice(0,8).forEach(k => lines.push('<div><strong>' + escapeHtml(k) + ':</strong> ' + escapeHtml(props[k]) + '</div>'));
      }
      lines.push('</div>');
      return lines.join('<br>');
    }

    // Normalize property keys to predictable names
    function normalizeProperties(props){
      const out = {};
      Object.keys(props||{}).forEach(k => {
        const key = k.trim();
        const lower = key.toLowerCase().replace(/\s+/g,'_');
        out[key] = props[k];
        // map common fields to consistent names
        if(['sektor','sector'].includes(lower)) out.Sektor = props[k];
        if(['tahun_pembangunan','tahun','year'].includes(lower)) out.Tahun_Pembangunan = props[k];
        if(['nama_infrastruktur','name','nama'].includes(lower)) out.Nama_Infrastruktur = props[k];
        if(['status_keberfungsian','status'].includes(lower)) out.Status_Keberfungsian = props[k];
      });
      return out;
    }

    // Populate filters from geoData
    function populateFilters(geo){
      uniqueSectors.clear(); uniqueYears.clear();
      geo.features.forEach(f => {
        const p = normalizeProperties(f.properties || {});
        if(p.Sektor && String(p.Sektor).trim()) uniqueSectors.add(String(p.Sektor).trim());
        if(p.Tahun_Pembangunan && String(p.Tahun_Pembangunan).trim() && !isNaN(String(p.Tahun_Pembangunan).trim())) uniqueYears.add(String(p.Tahun_Pembangunan).trim());
      });
      const sectorSelect = document.getElementById('sectorFilter');
      sectorSelect.innerHTML = '<option value="">Semua Sektor</option>' + Array.from(uniqueSectors).sort().map(s => '<option value="'+escapeHtml(s)+'">'+escapeHtml(s)+'</option>').join('');
      const yearSelect = document.getElementById('yearFilter');
      yearSelect.innerHTML = '<option value="">Semua Tahun</option>' + Array.from(uniqueYears).sort((a,b)=>Number(a)-Number(b)).map(y => '<option value="'+escapeHtml(y)+'">'+escapeHtml(y)+'</option>').join('');
      updateFilterInfo(allMarkers.length);
    }

    function updateFilterInfo(count){
      const el = document.getElementById('filterInfo');
      el.textContent = 'Menampilkan ' + count + ' titik.';
    }

    // Create markers for point features only. Use clustering for performance.
    function createMarkersFromGeo(geo){
      clearAllMarkers();
      const markers = [];
      const bounds = new google.maps.LatLngBounds();

      geo.features.forEach(f => {
        if(!f.geometry) return;
        const geomType = f.geometry.type;
        if(geomType !== 'Point') return; // skip non-point for marker creation
        const coords = f.geometry.coordinates;
        if(!Array.isArray(coords) || coords.length < 2) return;
        const lng = Number(coords[0]);
        const lat = Number(coords[1]);
        if(!isFinite(lat) || !isFinite(lng)) return;

        const props = normalizeProperties(f.properties || {});

        const marker = new google.maps.Marker({
          position: { lat, lng },
          title: props.Nama_Infrastruktur || '',
          optimized: true,
        });

        marker.addListener('click', () => {
          const content = '<div style="color:#111;background:#fff;padding:10px;border-radius:6px;max-width:320px;">' + buildInfoHtml(props) + '</div>';
          infoWindow.setContent(content);
          infoWindow.open(map, marker);
        });

        markers.push({ marker, props });
        bounds.extend(marker.getPosition());
      });

      allMarkers = markers;

      // Use MarkerClusterer for many markers
      if(markerCluster) markerCluster.clearMarkers();
      const simpleMarkers = allMarkers.map(m => m.marker);
      markerCluster = new MarkerClusterer(map, simpleMarkers, { imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m' });

      // Fit bounds if markers present
      if(!bounds.isEmpty()) map.fitBounds(bounds);

      return simpleMarkers.length;
    }

    function clearAllMarkers(){
      if(markerCluster) markerCluster.clearMarkers();
      allMarkers.forEach(m => { m.marker.setMap(null); });
      allMarkers = [];
    }

    // Apply filter with moderate throttling
    let filterTimeout = null;
    function applyFilter(){
      hideError();
      const sector = document.getElementById('sectorFilter').value;
      const year = document.getElementById('yearFilter').value;
      currentFilter.sector = sector; currentFilter.year = year;

      if(allMarkers.length === 0){ updateFilterInfo(0); return; }

      // Update visibility
      let visibleCount = 0;
      allMarkers.forEach(({ marker, props }) => {
        const matchesSector = !sector || (props.Sektor && String(props.Sektor).trim() === sector);
        const matchesYear = !year || (props.Tahun_Pembangunan && String(props.Tahun_Pembangunan).trim() === year);
        if(matchesSector && matchesYear){ marker.setMap(map); visibleCount++; } else { marker.setMap(null); }
      });

      // Update cluster with currently visible markers
      const visibleMarkers = allMarkers.filter(m => m.marker.getMap()).map(m => m.marker);
      if(markerCluster) markerCluster.clearMarkers();
      markerCluster = new MarkerClusterer(map, visibleMarkers, { imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m' });

      updateFilterInfo(visibleCount);
      if(visibleCount > 0){
        const b = new google.maps.LatLngBounds();
        visibleMarkers.forEach(m => b.extend(m.getPosition()));
        if(!b.isEmpty()) map.fitBounds(b);
      }
    }

    function resetFilter(){
      document.getElementById('sectorFilter').value = '';
      document.getElementById('yearFilter').value = '';
      currentFilter.sector = ''; currentFilter.year = '';
      // restore all markers
      allMarkers.forEach(m => m.marker.setMap(map));
      if(markerCluster) markerCluster.clearMarkers();
      markerCluster = new MarkerClusterer(map, allMarkers.map(m => m.marker), { imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m' });
      updateFilterInfo(allMarkers.length);
      // fit bounds
      const b = new google.maps.LatLngBounds();
      allMarkers.forEach(m => b.extend(m.marker.getPosition()));
      if(!b.isEmpty()) map.fitBounds(b);
    }

    // Load GeoJSON via fetch. Expect path relative to repo or absolute URL with CORS allowed
    async function loadGeoJSON(url){
      showLoading(); hideError();
      try{
        const res = await fetch(url);
        if(!res.ok) throw new Error('Gagal memuat GeoJSON: ' + res.status);
        const geo = await res.json();
        geoData = geo;

        // create markers and populate filters
        const count = createMarkersFromGeo(geo);
        populateFilters(geo);
        updateFilterInfo(count);
      }catch(err){
        showError(err.message);
      }finally{
        hideLoading();
      }
    }

    // initMap called by Google Maps API after load
    function initMap(){
      map = new google.maps.Map(document.getElementById('map'), {
        center: { lat: -3.3, lng: 129.1 },
        zoom: 7,
        mapTypeControl: false,
        streetViewControl: false,
      });
      infoWindow = new google.maps.InfoWindow({ maxWidth: 320 });

      // Wire UI
      document.getElementById('applyBtn').addEventListener('click', () => applyFilter());
      document.getElementById('resetBtn').addEventListener('click', () => resetFilter());

      // Load GeoJSON. Replace path with your file in repo.
      loadGeoJSON('DATA_SPASIAL.geojson');

      // Improve map performance for large datasets
      map.addListener('idle', () => { /* placeholder for future progressive rendering */ });
    }

    // Expose for debugging
    window.initMap = initMap;
    window.loadGeoJSON = loadGeoJSON;
  </script>
</body>
</html>
