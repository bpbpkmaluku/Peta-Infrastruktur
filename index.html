<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Google Maps + GeoJSON + WMS - Simple</title>
  <style>
    html,body{height:100%;margin:0;font-family:Arial,Helvetica,sans-serif}
    #map{height:100vh;width:100%}
    #panel{position:absolute;left:10px;top:10px;background:#fff;padding:8px;border-radius:6px;box-shadow:0 2px 6px rgba(0,0,0,.2);z-index:5}
    .btn{display:inline-block;padding:6px 10px;margin:4px 0;border:1px solid #888;border-radius:4px;cursor:pointer;background:#f7f7f7}
    .info{font-size:13px}
  </style>
  <!-- Ganti YOUR_API_KEY dengan API key Google Maps Anda. Aktifkan Maps JavaScript API. -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBEZqcze-RGCcRGIBjyEt0-ID99TCDJeS0"></script>
</head>
<body>
  <div id="panel">
    <div style="font-weight:600;margin-bottom:6px">Peta Infrastruktur - Demo</div>
    <div class="btn" id="loadGeojson">Load GeoJSON</div>
    <div class="btn" id="toggleWMS">Toggle WMS</div>
    <div class="info" id="status"></div>
  </div>
  <div id="map"></div>

  <script>
    // Konfigurasi
    const GEOJSON_URL = 'https://github.com/bpbpkmaluku/Peta-Infrastruktur/blob/main/DATA_SPASIAL.geojson'; // Ganti dengan path raw GitHub Anda jika perlu
    const WMS_BASE = 'https://demo.mapserver.org/cgi-bin/wms'; // Contoh WMS

    let map;
    let wmsTileLayer = null;
    const markers = [];
    const infoWindow = new google.maps.InfoWindow();

    function initMap() {
      map = new google.maps.Map(document.getElementById('map'), {
        center: { lat: -3.5, lng: 128.2 },
        zoom: 6
      });

      document.getElementById('loadGeojson').addEventListener('click', () => loadGeoJSON(GEOJSON_URL));
      document.getElementById('toggleWMS').addEventListener('click', toggleWMS);

      // Option: load automatically
      // loadGeoJSON(GEOJSON_URL);
    }

    // Muat GeoJSON menggunakan fetch dan tambahkan ke map.data
    async function loadGeoJSON(url) {
      setStatus('Memuat GeoJSON...');
      clearData();

      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const geojson = await res.json();

        // Tambah ke Data layer
        map.data.addGeoJson(geojson);

        // Styling sederhana
        map.data.setStyle(feature => {
          const geom = feature.getGeometry().getType();
          if (geom === 'Point') return { icon: getCircleIcon(8) };
          if (geom === 'LineString') return { strokeWeight: 3, strokeColor: '#1f78b4' };
          return { fillColor: '#33a02c', strokeColor: '#006400', strokeWeight: 1 };
        });

        // Buat marker untuk point agar InfoWindow lebih stabil di semua browser
        map.data.forEach(f => {
          if (f.getGeometry().getType() === 'Point') {
            const latLng = toLatLng(f.getGeometry().get());
            const marker = new google.maps.Marker({ position: latLng, map });
            marker.feature = f; // referensi balik
            marker.addListener('click', () => showFeatureInfo(f, marker));
            markers.push(marker);
          }
        });

        setStatus('Selesai. Fitur: ' + countFeatures(geojson));
      } catch (err) {
        console.error(err);
        setStatus('Gagal memuat GeoJSON: ' + err.message);
      }
    }

    function countFeatures(geojson) {
      if (!geojson) return 0;
      if (geojson.type === 'FeatureCollection') return geojson.features.length;
      return 1;
    }

    function toLatLng(coords) {
      // Google Maps Data returns LatLngLiteral for point via feature.getGeometry().get()
      if (coords.lat !== undefined && coords.lng !== undefined) return coords;
      // Some GeoJSON parsers give [lng,lat]
      return { lat: coords[1], lng: coords[0] };
    }

    function showFeatureInfo(feature, anchor) {
      const props = feature.getProperties();
      let content = '<div style="min-width:180px">';
      for (const k in props) {
        content += '<div><strong>' + escapeHtml(k) + '</strong>: ' + escapeHtml(String(props[k])) + '</div>';
      }
      content += '</div>';
      infoWindow.setContent(content);
      infoWindow.open(map, anchor);
    }

    function escapeHtml(s) {
      return s.replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;');
    }

    function getCircleIcon(size) {
      return {
        path: google.maps.SymbolPath.CIRCLE,
        scale: size,
        fillColor: '#1f78b4',
        fillOpacity: 0.9,
        strokeWeight: 0
      };
    }

    function clearData() {
      // Hapus data layer
      map.data.forEach(f => map.data.remove(f));
      // Hapus marker
      markers.forEach(m => m.setMap(null));
      markers.length = 0;
      setStatus('');
    }

    function setStatus(text) { document.getElementById('status').textContent = text; }

    // WMS overlay sederhana via ImageMapType
    function createWMSLayer() {
      const tileSize = 256;
      return new google.maps.ImageMapType({
        getTileUrl: (coord, zoom) => {
          const bounds = getTileBounds(coord.x, coord.y, zoom);
          const params = new URLSearchParams({
            service: 'WMS',
            version: '1.1.1',
            request: 'GetMap',
            layers: 'bluemarble',
            styles: '',
            srs: 'EPSG:4326',
            bbox: [bounds.south, bounds.west, bounds.north, bounds.east].join(','),
            width: tileSize,
            height: tileSize,
            format: 'image/png',
            transparent: 'true'
          });
          return WMS_BASE + '?' + params.toString();
        },
        tileSize
      });
    }

    function toggleWMS() {
      if (wmsTileLayer) {
        map.overlayMapTypes.removeAt(map.overlayMapTypes.getLength() - 1);
        wmsTileLayer = null;
        setStatus('WMS dimatikan');
        return;
      }
      wmsTileLayer = createWMSLayer();
      map.overlayMapTypes.insertAt(map.overlayMapTypes.getLength(), wmsTileLayer);
      setStatus('WMS aktif');
    }

    // Helper: hitung bbox tile di EPSG:4326
    function getTileBounds(x, y, z) {
      const n = Math.pow(2, z);
      const lonLeft = x / n * 360 - 180;
      const lonRight = (x + 1) / n * 360 - 180;
      const latTop = rad2deg(Math.atan(Math.sinh(Math.PI * (1 - 2 * y / n))));
      const latBottom = rad2deg(Math.atan(Math.sinh(Math.PI * (1 - 2 * (y + 1) / n))));
      return { west: lonLeft, east: lonRight, north: latTop, south: latBottom };
    }
    function rad2deg(r) { return r * 180 / Math.PI; }

    // Start
    window.initMap = initMap;
    // Jika Google API sudah dimuat tanpa callback, panggil initMap
    if (typeof google === 'object' && google.maps) initMap();
  </script>
</body>
</html>
